<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gesti√≥n Viaje Estudios</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#184778">

<link rel="apple-touch-icon" href="icons/icon-192.png">

<!-- Librer√≠as -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

<style>
/* ===================== PALETA PASTEL ===================== */
:root {
    --primary:#9BBCE0;
    --primary-dark:#6D8BC3;
    --primary-soft:#E3ECF8;

    --accent-green:#A8E6CF;
    --accent-orange:#FFD6A5;
    --accent-purple:#D6C4F3;
    --accent-red:#FFB5A7;

    --text-main:#333;
    --text-soft:#555;
    --border-soft:#E0E4EC;
    --bg-body:#F5F7FB;
    --bg-card:#FFF;
}

/* ===================== GLOBALES ===================== */
html, body { max-width: 100%; overflow-x: hidden; }
body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: var(--bg-body);
    color: var(--text-main);
}
.content-section { padding: 20px; }

/* ===================== NAVBAR ===================== */
.navbar {
    display:flex;
    gap:8px;
    background:var(--primary);
    padding:10px;
    box-shadow:0 2px 6px rgba(0,0,0,0.08);
}
.nav-link {
    background:#8FB0D8;
    border:none;
    border-radius:999px;
    padding:8px 14px;
    font-size:.9rem;
    color:#FFF;
    cursor:pointer;
}
.nav-link.active { background:var(--primary-dark); }

/* ===================== TARJETAS ===================== */
.card {
    background:var(--bg-card);
    padding:18px;
    border-radius:14px;
    margin-bottom:22px;
    border:1px solid var(--border-soft);
    box-shadow:0 2px 10px rgba(149,157,165,0.15);
}

/* ===================== TABLAS ===================== */
table { width:100%; border-collapse:collapse; }
th,td {
    border:1px solid #E2E5F0;
    padding:8px;
    font-size:.9rem;
}
th {
    background:var(--primary-soft);
    font-weight:600;
}
tbody tr:nth-child(even){ background:#F8FAFF; }

/* ===================== BOTONES ===================== */
button {
    border:none;
    border-radius:999px;
    cursor:pointer;
    padding:9px 14px;
    font-size:.9rem;
    color:#FFF;
}
.btn-add{ background:#B388EB; }
.btn-success{ background:#8FD5A6; }
.btn-danger{ background:#FF9B9B; }
.btn-edit{ background:#6D8BC3; }

/* ===================== MODALES BASE ===================== */
.modal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    backdrop-filter: blur(6px);
    background: rgba(0,0,0,0.32);
    z-index: 5000;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.modal-content {
    position: relative;
    background: rgba(255,255,255,0.85);
    width: 95%;
    max-width: 700px;
    max-height: 90vh;
    padding: 32px;
    padding-top: 60px;
    border-radius: 18px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    border: 1px solid var(--border-soft);
    display: flex;
    flex-direction: column;
    gap: 22px;
    font-family: "Segoe UI", Roboto, sans-serif;
    animation: appearModal .22s ease-out;
    overflow-y: auto;
}

/* footer de acciones siempre accesible */
.modal-content .modal-actions{
    position: sticky;
    bottom: 0;
    background: rgba(255,255,255,0.92);
    padding: 10px 0;
    margin-top: 10px;
    z-index: 20;
}

@keyframes appearModal {
    from { opacity: 0; transform: translateY(30px) scale(.95); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
}

/* BARRA SUPERIOR */
.modal-header-bar {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 52px;
    padding: 0 18px;
    display: flex;
    align-items: center;
    gap: 10px;
    border-radius: 18px 18px 0 0;
    font-weight: bold;
    color: #fff;
    font-size: 1.05rem;
}
.modal-header-bar i { font-size: 1.6rem; }

.modal-content[data-type="alumno"] .modal-header-bar { background: var(--accent-purple); }
.modal-content[data-type="actividad"] .modal-header-bar { background: var(--primary-dark); }
.modal-content[data-type="proveedor"] .modal-header-bar { background: var(--accent-orange); }
.modal-content[data-type="pago"] .modal-header-bar { background: var(--accent-green); }
.modal-content[data-type="config"] .modal-header-bar { background: var(--primary); }

/* Inputs */
.modal-content .form-grid,
.modal-content form {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    width: 100%;
}
.modal-content label {
    color: var(--text-main);
    margin-top: 8px;
    font-weight: 600;
}
.modal-content input,
.modal-content select,
.modal-content textarea {
    width: 100%;
    background: #fff;
    border-radius: 10px;
    border: 1px solid var(--border-soft);
    padding: 10px;
    box-sizing:border-box;
}
.modal-content textarea { min-height: 80px; }

.modal-actions {
    display: flex;
    justify-content: center;
    gap: 14px;
}
.modal-content button { min-width: 120px; font-weight: bold; }

@media(max-width: 600px){
    .modal-content .form-grid,
    .modal-content form { grid-template-columns: 1fr; }
    .modal-actions { flex-direction: column; }
}

/* ===================== INFORMES ‚Äî PANEL IZQUIERDO ===================== */
#reportsSidebar{
    width:260px;
    position:fixed;
    top:60px;
    left:0;
    height:calc(100vh - 60px);
    padding:20px 10px;
    border-right:1px solid var(--border-soft);
    background:var(--bg-card);
    overflow-y:auto;
}
.sidebar-title{ font-size:1.1rem; font-weight:bold; margin-bottom:8px; }
.sidebar-group{ margin:16px 0 6px; font-weight:bold; color:var(--primary-dark); }
.sidebar-list{ list-style:none; padding-left:12px; }
.sidebar-list li{
    cursor:pointer;
    padding:6px 4px;
    margin:3px 0;
    font-size:.9rem;
    color:var(--text-soft);
    border-radius:6px;
}
.sidebar-list li:hover{ background:var(--primary-soft); }

/* ===================== INFORMES ‚Äî CONTENIDO DERECHA ===================== */
#reportsContent{
    margin-left:260px;
    padding:25px;
    width:calc(100% - 260px);
    min-height:calc(100vh - 60px);
    display:flex;
    justify-content:center;
}
#reportViewContainer{
    width:100%;
    max-width:1100px;
    margin:auto;
}

@media(max-width:900px){
    #reportsSidebar{ transform:translateX(-260px); }
    #reportsSidebar.visible{ transform: translateX(0); }
    #reportsContent{
        margin-left:0;
        padding:15px;
        width:100% !important;
    }
}

.pastel-card{
    background:#F1F5FA;
    border:1px solid var(--border-soft);
    border-radius:12px;
    text-align:center;
    padding:15px;
    font-size:.9rem;
}
.kpi-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
    gap:12px;
}

.ranking-wrapper{ max-height:420px; overflow-y:auto; }
#barRanking{ width:100% !important; height:900px !important; }

.wide-modal{
    max-width: 850px !important;
    width: 95%;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}
.sales-scroll{
    max-height: 60vh;
    overflow-y: auto;
    margin-bottom: 15px;
    padding-right: 5px;
}
.fixed-actions{
    display: flex;
    justify-content: center;
    gap: 15px;
    padding: 12px 0;
    background: white;
    border-top: 1px solid #e3e3e3;
    position: sticky;
    bottom: 0;
    border-radius: 0 0 14px 14px;
}
#salesModal table th {
    position: sticky;
    top: 0;
    background: var(--primary-soft);
    z-index: 5;
}

/* ===== ICONOS IMPORTAR/EXPORTAR NAVBAR ===== */
.nav-icon-btn {
    background: transparent;
    border: none;
    margin-left: auto;
    color: white;
    font-size: 1.4rem;
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 6px 10px;
    border-radius: 8px;
    transition: 0.15s;
}
.nav-icon-btn:hover {
    background: rgba(255,255,255,0.18);
    transform: translateY(-2px);
}

/* === DASHBOARD INFORMES - LAYOUT=== */
.global-grid {
    display: grid;
    grid-template-columns: 1fr 1.2fr;
    gap: 22px;
}
.chart-card {
    background: var(--bg-card);
    padding: 18px;
    border-radius: 14px;
    border:1px solid var(--border-soft);
    box-shadow:0 2px 10px rgba(149,157,165,0.15);
}
.chart-title {
    text-align:center;
    margin-bottom:10px;
    color: var(--text-soft);
}
.report-table {
    width:100%;
    border-collapse:collapse;
    font-size:0.9rem;
}
.report-table th, 
.report-table td {
    border:1px solid #E2E5F0;
    padding:6px;
}
.complete-row { background:#c9f5d6 !important; font-weight:600; }
#rankingTableBody { font-size:0.9rem; }

@media(max-width:900px){
    .global-grid{ grid-template-columns: 1fr; }
}

/* ===== MODAL PAGOS FIX ===== */
#activityPaymentsModal .modal-header-bar {
    position: sticky;
    top: 0;
    z-index: 10;
}
#activityPaymentsModal .modal-footer {
    position: sticky;
    bottom: 0;
    background: white;
    border-top: 1px solid #ddd;
    padding: 12px;
    display: flex;
    justify-content: center;
    gap: 12px;
    z-index: 10;
}
#activityPaymentsModal button { min-width: 120px; font-weight: bold; }

.btn-close-modal{
    position:absolute;
    top:10px;
    right:12px;
    background:#ff7b7b;
    color:#fff;
    width:32px;
    height:32px;
    border:none;
    border-radius:50%;
    font-size:16px;
    display:flex;
    justify-content:center;
    align-items:center;
    cursor:pointer;
    z-index:15;
}

/* SELECTS INFORMES */
.report-filter-select {
    width: 100%;
    padding: 10px 12px;
    font-size: 0.95rem;
    border-radius: 8px;
    border: 1px solid var(--border-soft);
    background: #fff;
    color: var(--text-soft);
    margin-top: 6px;
    box-sizing: border-box;
}
.report-filter-box {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    background: var(--bg-card);
    border-radius: 12px;
    border:1px solid var(--border-soft);
}
.report-filter-container {
    display: flex;
    flex-direction: column;
    width: 100%;
    gap: 8px;
}

/* BOTONES PDF */
.btn-pdf {
    background: #1e88e5;
    color: white !important;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: bold;
    font-size: .9rem;
    cursor: pointer;
    transition: .15s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}
.btn-pdf:hover:not(:disabled) {
    background: #1565c0;
    transform: translateY(-2px);
}
.btn-pdf:disabled {
    background: #d0d7e4;
    color: #97a1b3 !important;
    cursor: not-allowed;
    transform: none;
}

@media (max-width: 480px) {
    .modal-content { padding: 12px !important; }
    button, .btn-add, .btn-danger, .btn-edit, .btn-success, .btn-pdf {
        padding: 12px 16px !important;
        font-size: 1rem !important;
        border-radius: 10px !important;
    }
    h1, h2, h3 { font-size: 1.2rem !important; }
    input, select { font-size: 1rem !important; padding: 10px !important; }
}

@media (max-width: 768px) {
    #reportsSidebar {
        position: fixed;
        width: 70% !important;
        max-width: 260px;
        height: 100vh;
        top: 0;
        left: -75%;
        background: white;
        box-shadow: 2px 0 10px rgba(0,0,0,0.15);
        z-index: 3000;
        transition: left 0.3s ease;
        padding-top: 20px;
    }
    #reportsSidebar.open { left: 0; }
    #openReportsMenu { display: block !important; z-index: 4000; }
    #reportsContent { margin-left: 0 !important; padding: 10px !important; }
    .kpi-grid, .global-grid { display: block !important; }
    .chart-card { margin-bottom: 20px !important; }
}

.material-icons-outlined, .material-icons {
    vertical-align: middle;
    font-size: 1.2rem;
}
#reportViewContainer, .report-view {
    overflow-x: auto;
    min-height: 60vh;
    box-sizing: border-box;
}
.report-table th, .report-table td {
    word-break: keep-all;
    white-space: nowrap;
}
/* =========================
   FIX MODAL PAGOS - TABLET
   Botones siempre visibles
   ========================= */

#paymentModal{
  align-items: center;
}

#paymentModal .modal-content{
  max-height: 90vh;
  overflow: hidden;            /* el scroll lo har√° el cuerpo interno */
  display: flex;
  flex-direction: column;
}

/* Todo el contenido del modal (excepto botones) puede scrollear */
#paymentModal .modal-content > :not(.modal-actions){
  flex: 0 0 auto;
}

/* Fuerza que el bloque principal pueda hacer scroll si hace falta */
#paymentModal .modal-content{
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

/* Botonera siempre visible abajo */
#paymentModal .modal-actions{
  position: sticky;
  bottom: 0;
  background: rgba(255,255,255,0.98);
  padding: 12px 0;
  margin-top: 10px;
  border-top: 1px solid #e3e3e3;
  z-index: 20;
}
</style>
</head>

<body>

<!-- ========== NAVBAR ========== -->
<nav class="navbar">
    <button class="nav-link active" data-section="dashboard">üéØ Dashboard</button>
    <button class="nav-link" data-section="students">üéì Alumnos</button>
    <button class="nav-link" data-section="activities">üõ†Ô∏è Actividades</button>
    <button class="nav-link" data-section="providers">üé∞ Proveedores</button>
    <button class="nav-link" data-section="payments">üíµ Pagos</button>
    <button class="nav-link" data-section="reports">üìä Informes</button>

    <!-- Import/Export: NO usan data-section para no romper navegaci√≥n -->
    <button class="nav-link" type="button" onclick="openModal('exportModal')">üöÄ Copiar</button>
    <button class="nav-link" type="button" onclick="openModal('importModal')">üõ¨ Restaurar</button>
</nav>

<!-- ========== DASHBOARD ========== -->
<section id="dashboard" class="content-section" style="display:block;">
    <h2 style="display:flex;align-items:center;gap:8px;font-size:1.6rem;">
        <span class="material-icons-outlined" style="font-size:2rem;">dashboard</span>
        Dashboard
    </h2>
    <p style="margin-top:-6px;color:#555;">Seguimiento en tiempo real del viaje de estudios</p>

    <div id="kpiContainer" class="kpi-grid" style="margin-top:18px;">
        <div class="pastel-card">
            <div class="material-icons-outlined" style="font-size:36px;color:#2979FF;">payments</div>
            <div style="font-size:0.85rem;">Recaudado Total</div>
            <strong id="kpiTotal" style="font-size:1.3rem;">0 ‚Ç¨</strong>
        </div>

        <div class="pastel-card">
            <div class="material-icons-outlined" style="font-size:36px;color:#EF6C00;">hourglass_bottom</div>
            <div style="font-size:0.85rem;">Pendiente Total</div>
            <strong id="kpiPending" style="font-size:1.3rem;">0 ‚Ç¨</strong>
        </div>

        <div class="pastel-card">
            <div class="material-icons-outlined" style="font-size:36px;color:#2E7D32;">check_circle</div>
            <div style="font-size:0.85rem;">% Completado Grupo</div>
            <strong id="kpiPercent" style="font-size:1.3rem;">0%</strong>
        </div>

        <div class="pastel-card">
            <div class="material-icons-outlined" style="font-size:36px;color:#6A1B9A;">emoji_events</div>
            <div style="font-size:0.85rem;">Alumnos Completados</div>
            <strong id="kpiCompleted" style="font-size:1.3rem;">0</strong>
        </div>
    </div>

    <h3 style="margin-top:28px;margin-bottom:10px;color:#c62828;display:flex;gap:6px;align-items:center;">
        <span class="material-icons-outlined">warning_amber</span>
        Pagos Pendientes a Proveedores
    </h3>

    <div id="dashboardPaymentsContainer" class="card" style="padding:15px;">
        <p style="text-align:center;color:#777;">Sin pagos pendientes</p>
    </div>

    <div style="display:flex;flex-wrap:wrap;gap:20px;margin-top:25px;">
        <div class="chart-card" style="flex:1;min-width:270px;">
            <h3 class="chart-title">Situaci√≥n del Grupo</h3>
            <canvas id="donutChart"></canvas>
        </div>

        <div class="chart-card" style="flex:1; min-width:350px;">
            <h3 class="chart-title">Ranking Aportaciones</h3>
            <div class="ranking-wrapper">
                <canvas id="barRanking"></canvas>
            </div>
        </div>
    </div>
</section>

<!-- ========== ALUMNOS ========== -->
<section id="students" class="content-section" style="display:none;">
    <h2>üë®‚Äçüéì Gesti√≥n de Alumnos</h2>
    <button class="btn-add" onclick="openStudentModal()">‚ûï Nuevo Alumno</button>

    <div class="card">
        <table>
        <thead>
            <tr>
                <th>Alumno</th><th>Clase</th><th>Tutor</th>
                <th>Tel√©fono</th><th>Beneficio</th>
                <th>Pendiente</th><th>% pagado</th><th>Acciones</th>
            </tr>
        </thead>
        <tbody id="studentTableBody"></tbody>
        </table>
    </div>
</section>

<!-- ACTIVIDADES -->
<section id="activities" class="content-section" style="display:none;">
    <h2>üì¶ Actividades de Venta</h2>
    <button class="btn-add" onclick="openActivityModal()">‚ûï Nueva Actividad</button>

    <div class="card">
        <table>
            <thead>
                <tr>
                    <th>Actividad</th>
                    <th>Proveedor</th>
                    <th>Beneficio total</th>
                    <th>Deuda total proveedor</th>
                    <th>Pendiente</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="activityTableBody"></tbody>
        </table>
    </div>
</section>

<!-- PROVEEDORES -->
<section id="providers" class="content-section" style="display:none;">
    <h2>üè™ Proveedores</h2>
    <button class="btn-add" onclick="openProviderModal()">‚ûï Nuevo Proveedor</button>

    <div class="card">
        <table>
            <thead>
                <tr>
                    <th>Proveedor</th>
                    <th>Contacto</th>
                    <th>Tel√©fono</th>
                    <th>Deuda total (‚Ç¨)</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="providerTableBody"></tbody>
        </table>
    </div>
</section>

<!-- PAGOS -->
<section id="payments" class="content-section" style="display:none;">
    <h2>üí∂ Gesti√≥n de Pagos a Proveedores</h2>
    <p style="color:#555;margin-bottom:15px;">
        Control de pagos realizados y pendientes por proveedor y actividad.
    </p>

    <div class="card" style="margin-bottom:20px; padding:10px;">
        <label><strong>Proveedor:</strong>
            <select id="paymentsProviderFilter" onchange="updatePaymentsView()">
                <option value="all">Todos</option>
            </select>
        </label>

        <label style="margin-left:20px;"><strong>Actividad:</strong>
            <select id="paymentsActivityFilter" onchange="updatePaymentsView()">
                <option value="all">Todas</option>
            </select>
        </label>

        <button class="btn-add" style="margin-left:20px;" onclick="fillPendingAmount(event)">
            Rellenar pendiente
        </button>
    </div>

    <div id="paymentsSummaryKPI" class="kpi-grid" style="margin-bottom:20px;"></div>

    <div id="paymentsTableContainer" class="card" style="padding:10px; margin-bottom:20px;">
        <p style="text-align:center;color:#888;">No hay pagos registrados</p>
    </div>

    <button class="btn-add" onclick="addProviderPayment(event)" style="display:none;">
        ‚ûï Registrar Pago Manual
    </button>
</section>

<!-- INFORMES -->
<section id="reports" class="content-section" style="display:none; padding:0;">
    <button id="openReportsMenu" class="btn-add"
        style="position:absolute; top:10px; left:10px; z-index:2000; display:none;">
        <span class="material-icons-outlined">menu</span>
    </button>

    <aside id="reportsSidebar">
        <h3 class="sidebar-title">üìÑ Informes</h3>
        <ul class="sidebar-list">
            <li onclick="showReportView('global')">üåç Situaci√≥n Global del Viaje</li>

            <li class="sidebar-group">üë®‚Äçüéì Alumnos</li>
            <li onclick="showReportView('studentsTotal')">‚Ü≥ Informe total alumnos</li>
            <li onclick="showReportView('studentSingle')">‚Ü≥ Informe por alumno</li>
            <li onclick="showReportView('studentsActivity')">‚Ü≥ Filtro por Actividad</li>

            <li class="sidebar-group">üì¶ Actividades</li>
            <li onclick="showReportView('activities')">‚Ü≥ Informe Actividades</li>

            <li class="sidebar-group">üè™ Proveedores</li>
            <li onclick="showReportView('providers')">‚Ü≥ Informe Proveedores</li>

            <li class="sidebar-group">üí∂ Pagos</li>
            <li onclick="showReportView('payments')">‚Ü≥ Informe Pagos Global</li>
        </ul>
    </aside>

    <div id="reportsContent">
        <div id="reportViewContainer" class="report-view">
            <h2>Selecciona un informe a la izquierda</h2>
        </div>
    </div>
</section>
<!-- ========== MODAL: ALUMNO ========== -->
<div id="studentModal" class="modal">
  <div class="modal-content" data-type="alumno">
    <div class="modal-header-bar">
        <i class="material-icons-outlined">person_add</i> Alumno
    </div>

    <div class="form-grid">
        <label>Nombre
            <input type="text" id="studentName" required>
        </label>

        <label>Clase
            <select id="studentClass">
                <option value="4A">4A</option>
                <option value="4B">4B</option>
            </select>
        </label>

        <label>Tutor legal
            <input type="text" id="studentTutor">
        </label>

        <label>Tel√©fono
            <input type="text" id="studentPhone">
        </label>

        <label>Alergias
            <input type="text" id="studentAlergias">
        </label>

        <label>Medicamentos
            <input type="text" id="studentMedicamentos">
        </label>

        <label>Observaciones
            <textarea id="studentObs" rows="2"></textarea>
        </label>
    </div>

    <div class="modal-actions">
        <button class="btn-success" onclick="saveStudent()">Guardar</button>
        <button class="btn-danger" onclick="closeStudentModal()">Cancelar</button>
    </div>
  </div>
</div>

<!-- ========== MODAL: SALUD ========== -->
<div id="healthModal" class="modal">
  <div class="modal-content">
    <div class="modal-header-bar" style="background:var(--primary);">
        <i class="material-icons-outlined">medical_information</i> Salud
    </div>

    <label>Alergias
        <textarea id="healthAllergies" rows="2"></textarea>
    </label>

    <label>Medicamentos
        <textarea id="healthMeds" rows="2"></textarea>
    </label>

    <label>Observaciones
        <textarea id="healthNotes" rows="2"></textarea>
    </label>

    <div class="modal-actions">
        <button id="btnSaveHealth" class="btn-success" type="button">Guardar</button>
        <button class="btn-danger" type="button" onclick="closeModal('healthModal')">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL ACTIVIDAD -->
<div id="activityModal" class="modal">
  <div class="modal-content" data-type="actividad">
    <div class="modal-header-bar">
        <i class="material-icons-outlined">work</i> Actividad
    </div>

    <div class="form-grid">
        <label>Nombre de la actividad
            <input type="text" id="activityName">
        </label>

        <label>Proveedor
            <select id="activityProvider"></select>
        </label>

        <label>Beneficio por alumno (‚Ç¨)
            <input type="number" id="activityBenefit" min="0" step="0.01" value="0" style="display:none;">
        </label>

        <label>Coste por alumno (‚Ç¨)
            <input type="number" id="activityCost" min="0" step="0.01" value="0" style="display:none;">
        </label>
    </div>

    <div class="modal-actions">
        <button class="btn-success" onclick="saveActivity()" type="button">Guardar</button>
        <button class="btn-danger" onclick="closeActivityModal()" type="button">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL ASIGNAR VENTAS -->
<div id="salesModal" class="modal" style="display:none;">
  <div class="modal-content wide-modal" data-type="pago">
    <div class="modal-header-bar">
      <i class="material-icons-outlined">attach_money</i>
      Gesti√≥n de Beneficios por Actividad
    </div>

    <div style="margin-top:10px; font-size:0.9rem;">
      <strong>Actividad:</strong> <span id="salesActivityName"></span>
    </div>

    <div class="sales-scroll">
      <table class="report-table">
        <thead>
          <tr>
            <th>Alumno</th>
            <th style="text-align:right;">Beneficio (‚Ç¨)</th>
            <th style="text-align:right;">Coste Proveedor (‚Ç¨)</th>
            <th style="text-align:right;">Total (‚Ç¨)</th>
          </tr>
        </thead>
        <tbody id="salesTableBody"></tbody>
      </table>
    </div>

    <div class="modal-actions fixed-actions">
      <button class="btn-success" onclick="saveSales()" type="button">Guardar</button>
      <button class="btn-danger" onclick="closeSalesModal()" type="button">Cerrar</button>
    </div>
  </div>
</div>

<!-- MODAL: PROVEEDOR -->
<div id="providerModal" class="modal">
  <div class="modal-content" data-type="proveedor">
    <div class="modal-header-bar">
        <i class="material-icons-outlined">store</i> Proveedor
    </div>

    <div class="form-grid">
        <label>Nombre proveedor
            <input type="text" id="providerName">
        </label>

        <label>Persona contacto
            <input type="text" id="providerContact">
        </label>

        <label>Tel√©fono
            <input type="text" id="providerPhone">
        </label>

        <label class="chk-provider-trip" style="grid-column:1 / 3;">
            <input type="checkbox" id="providerIsTrip">
            Proveedor del viaje
        </label>
    </div>

    <div class="modal-actions">
        <button class="btn-success" onclick="saveProvider()" type="button">Guardar</button>
        <button class="btn-danger" onclick="closeProviderModal()" type="button">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL: PAGO ALUMNO -->
<div id="paymentModal" class="modal">
  <div class="modal-content" data-type="pago" style="max-width:560px;">
    <div class="modal-header-bar">
        <i class="material-icons-outlined">paid</i> Pago Alumno
    </div>

    <h3 style="margin:0;">üí∂ Registrar Pago</h3>
    <p id="studentPaymentName" style="font-weight:bold;color:#333;margin:0;"></p>

    <label>Fecha
        <input type="date" id="studentPaymentDate">
    </label>

    <label>Importe (‚Ç¨)
        <input type="number" id="studentPaymentAmount" step="0.01" min="0">
    </label>

    <label>M√©todo
        <select id="studentPaymentMethod">
            <option>Efectivo</option>
            <option>Bizum</option>
            <option>Transferencia</option>
        </select>
    </label>

    <label>Notas
        <textarea id="studentPaymentNotes" rows="2"></textarea>
    </label>

    <h4 style="margin-bottom:6px;">üìú Historial de Pagos</h4>
    <div style="max-height:200px; overflow-y:auto; border:1px solid #ddd; border-radius:6px;">
        <table style="width:100%; font-size:0.85rem;">
            <thead>
                <tr style="background:#3498db;color:white;">
                    <th>Fecha</th>
                    <th>Importe</th>
                    <th>M√©todo</th>
                </tr>
            </thead>
            <tbody id="paymentHistoryTable"></tbody>
        </table>
    </div>

    <div class="modal-actions">
        <button class="btn-success" onclick="savePayment()" type="button">Guardar</button>
        <button class="btn-danger" onclick="closePaymentModal()" type="button">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL PAGOS ACTIVIDAD -->
<div id="activityPaymentsModal" class="modal" style="display:none;">
  <div class="modal-content wide-modal" data-type="pago">
    <button class="btn-close-modal" onclick="closeActivityPaymentsModal()" type="button">‚úñ</button>

    <div class="modal-header-bar">
        Gesti√≥n Pagos a Proveedor
    </div>

    <div id="activityPaymentsInfo" style="font-size:0.9rem;color:#333;margin-top:10px;"></div>

    <div class="form-grid">
        <div>
            <label><strong>Fecha</strong></label>
            <input type="date" id="providerPayDate">
        </div>

        <div>
            <label><strong>M√©todo</strong></label>
            <select id="providerPayMethod">
                <option value="Transferencia">Transferencia</option>
                <option value="Efectivo">Efectivo</option>
                <option value="Bizum">Bizum</option>
            </select>
        </div>

        <div style="grid-column:1 / 3;">
            <label><strong>Concepto</strong></label>
            <input type="text" id="providerPayConcept" placeholder="Ej: Pago parcial factura 123">
        </div>

        <div style="grid-column:1 / 3;">
            <label><strong>Importe (‚Ç¨)</strong></label>
            <input type="text" id="providerPayAmount" placeholder="Ej: 7032,58">
        </div>
    </div>

    <div class="modal-actions" style="margin-top:0;">
        <button class="btn-add" onclick="registerProviderPayment()" type="button">üíæ Guardar pago</button>
        <button class="btn-success" onclick="payActivityFullDebt()" type="button">üí∂ Pagar deuda total</button>
    </div>

    <h3 style="margin-top:10px;">Hist√≥rico de pagos</h3>

    <div style="max-height:32vh;overflow-y:auto;padding-right:6px;">
        <table class="report-table">
            <thead>
                <tr>
                    <th style="width:90px;">Fecha</th>
                    <th>Concepto</th>
                    <th style="width:110px;">M√©todo</th>
                    <th style="text-align:right;width:90px;">Importe</th>
                    <th style="width:70px;text-align:center;">Acc.</th>
                </tr>
            </thead>
            <tbody id="providerPaymentsTableBody">
                <tr><td colspan="5" style="text-align:center;color:#777;">Sin pagos registrados</td></tr>
            </tbody>
        </table>
    </div>
  </div>
</div>

<!-- MODAL EXPORTAR -->
<div id="exportModal" class="modal">
  <div class="modal-content" data-type="config">
      <div class="modal-header-bar">
          <i class="material-icons-outlined">backup</i> Copia de Seguridad
      </div>

      <p>Generar copia de seguridad de todos los datos actuales.</p>

      <div class="modal-actions">
          <button class="btn-success" onclick="exportData()" type="button">
              <span class="material-icons-outlined">file_download</span> Guardar copia
          </button>
          <button class="btn-danger" onclick="closeModal('exportModal')" type="button">
              <span class="material-icons-outlined">close</span> Cancelar
          </button>
      </div>
  </div>
</div>

<!-- MODAL IMPORTAR -->
<div id="importModal" class="modal">
  <div class="modal-content" data-type="config">
      <div class="modal-header-bar">
          <i class="material-icons-outlined">restore</i> Restaurar Datos
      </div>

      <p>Seleccione un archivo .json generado por la app.</p>

      <input type="file" id="importFile" accept="application/json">

      <div class="modal-actions">
          <button class="btn-success" onclick="importData()" type="button">
              <span class="material-icons-outlined">file_upload</span> Importar
          </button>
          <button class="btn-danger" onclick="closeModal('importModal')" type="button">
              <span class="material-icons-outlined">close</span> Cancelar
          </button>
      </div>
  </div>
</div>

<script>
/* =====================================================
   ESTADO GLOBAL + UTILIDADES
===================================================== */
function openModal(id){
  const m = document.getElementById(id);
  if (!m) return;
  m.style.display = "flex";
  if (id === "importModal"){
    const f = document.getElementById("importFile");
    if (f) f.value = "";
  }
}
function closeModal(id){
  const m = document.getElementById(id);
  if (m) m.style.display = "none";
}

let students = JSON.parse(localStorage.getItem("students") || "[]");
students = students.map(st => ({
  ...st,
  sales: Array.isArray(st.sales) ? st.sales : [],
  payments: Array.isArray(st.payments) ? st.payments : []
}));
localStorage.setItem("students", JSON.stringify(students));

let activities = JSON.parse(localStorage.getItem("activities") || "[]");
let providers  = JSON.parse(localStorage.getItem("providers") || "[]");

/* Fuente √∫nica */
window.providerPayments = JSON.parse(localStorage.getItem("providerPayments") || "[]");
if (!Array.isArray(window.providerPayments)) window.providerPayments = [];

let currentEditId = null;
let baseTripCost = 675;
let extraTripCost = 0;

function saveStudents(){ localStorage.setItem("students", JSON.stringify(students)); }
function saveActivities(){ localStorage.setItem("activities", JSON.stringify(activities)); }
function saveProviders(){ localStorage.setItem("providers", JSON.stringify(providers)); }
function saveProviderPayments(){
  localStorage.setItem("providerPayments", JSON.stringify(window.providerPayments));
}

/* =====================================================
   ALUMNOS
===================================================== */
function openStudentModal(id=null){
    currentEditId = id;
    document.getElementById("studentModal").style.display="flex";

    if(id){
        const s=students.find(x=>x.id===id);
        if(!s) return;
        studentName.value = s.name || "";
        studentClass.value = s.class || "4A";
        studentTutor.value = s.tutor || "";
        studentPhone.value = s.phone || "";
        studentAlergias.value = s.alergias || "";
        studentMedicamentos.value = s.medicamentos || "";
        studentObs.value = s.observaciones || "";
    } else {
        studentName.value = "";
        studentClass.value = "4A";
        studentTutor.value = "";
        studentPhone.value = "";
        studentAlergias.value = "";
        studentMedicamentos.value = "";
        studentObs.value = "";
    }
}
function closeStudentModal(){ closeModal("studentModal"); }

function saveStudent(){
    const existing = currentEditId ? students.find(s=>s.id===currentEditId) : null;

    const obj={
        id:currentEditId||("s"+Date.now()),
        name:studentName.value.trim(),
        class:studentClass.value,
        tutor:studentTutor.value.trim(),
        phone:studentPhone.value.trim(),
        alergias:studentAlergias.value.trim(),
        medicamentos:studentMedicamentos.value.trim(),
        observaciones:studentObs.value.trim(),
        sales: existing ? (existing.sales || []) : [],
        payments: existing ? (existing.payments || []) : []
    };

    if(!obj.name) return alert("Falta nombre");

    if(currentEditId){
        const i=students.findIndex(s=>s.id===currentEditId);
        students[i]=obj;
    } else {
        students.push(obj);
    }

    saveStudents();
    closeStudentModal();
    renderStudentsTable();
}

function openHealthModal(id){
    currentEditId=id;
    const s=students.find(x=>x.id===id);
    if(!s) return;
    healthAllergies.value=s.alergias||"";
    healthMeds.value=s.medicamentos||"";
    healthNotes.value=s.observaciones||"";
    openModal("healthModal");
}

btnSaveHealth.onclick=()=>{
    const s=students.find(x=>x.id===currentEditId);
    if(!s) return;

    s.alergias=healthAllergies.value.trim();
    s.medicamentos=healthMeds.value.trim();
    s.observaciones=healthNotes.value.trim();

    saveStudents();
    renderStudentsTable();
    closeModal("healthModal");
};

function deleteStudent(id){
    if(!confirm("¬øEliminar alumno?"))return;
    students=students.filter(s=>s.id!==id);
    saveStudents();
    renderStudentsTable();
}

function renderStudentsTable(){
    const tbody = document.getElementById('studentTableBody');
    tbody.innerHTML = "";

    if(!students.length){
        tbody.innerHTML = "<tr><td colspan='8' style='text-align:center;'>No hay alumnos</td></tr>";
        updateDashboard();
        return;
    }

    students.forEach(s => {
        const tripCost = baseTripCost + extraTripCost;

        const sales = Array.isArray(s.sales) ? s.sales : [];
        const payms = Array.isArray(s.payments) ? s.payments : [];

        const benefit = sales.reduce((a,b)=>a+(Number(b.benefit)||0),0);
        const payments = payms.reduce((a,b)=>a+(Number(b.amount)||0),0);

        const total = benefit + payments;
        const pending = tripCost - total;

        const percent = tripCost > 0
            ? Math.max(0, Math.min(100, Math.round((total / tripCost) * 100)))
            : 0;

        tbody.innerHTML += `
        <tr>
            <td><strong>${s.name || ""}</strong></td>
            <td>${s.class || ""}</td>
            <td>${s.tutor || ""}</td>
            <td>${s.phone || ""}</td>
            <td style="color:green;font-weight:bold;">${total.toFixed(2)}</td>
            <td style="color:#0275d8;font-weight:bold;">${pending.toFixed(2)}</td>
            <td>${percent}%</td>
            <td>
                <button class="btn-edit" type="button" onclick="openStudentModal('${s.id}')">‚úèÔ∏è</button>
                <button class="btn-add" type="button" style="background:#16a085;" onclick="openPaymentModal('${s.id}')">üí∂</button>
                <button class="btn-danger" type="button" onclick="deleteStudent('${s.id}')">üóëÔ∏è</button>
            </td>
        </tr>`;
    });

    updateDashboard();
}

/* =====================================================
   ACTIVIDADES
===================================================== */
let currentActivityId = null;

function openActivityModal(id=null){
    currentActivityId = id;
    openModal("activityModal");

    if(id){
        const a = activities.find(x=>x.id===id);
        if(!a) return;
        activityName.value = a.name || "";
        activityProvider.value = a.providerId || "";
    } else {
        activityName.value = "";
        activityProvider.value = "";
    }
}
function closeActivityModal(){ closeModal("activityModal"); }

function saveActivity(){
    const obj = {
        id: currentActivityId || ("act"+Date.now()),
        name: activityName.value.trim(),
        providerId: activityProvider.value.trim()
    };

    if(!obj.name) return alert("Nombre requerido");

    if(currentActivityId){
        const i = activities.findIndex(x=>x.id===currentActivityId);
        activities[i] = { ...activities[i], ...obj };
    } else {
        activities.push(obj);
    }

    saveActivities();
    closeActivityModal();
    renderActivitiesTable();
}
/* =====================================================
ACTIVIDADES ‚Äì TABLA
===================================================== */
function getActivityProviderBaseCost(activityId){
    let total = 0;
    students.forEach(st => {
        const sales = Array.isArray(st.sales) ? st.sales : [];
        sales.forEach(sa => {
            if (sa.activityId === activityId) total += Number(sa.providerCost || 0);
        });
    });
    return total;
}

function getActivityProviderTotals(activityId) {
    const activity = activities.find(a => a.id === activityId);
    if (!activity) {
        return { totalOwed: 0, totalPaid: 0, remaining: 0, providerId: null, providerName: "-" };
    }

    const providerId = activity.providerId || null;
    const providerName = providers.find(p => p.id === providerId)?.name || "-";

    const totalOwed = getActivityProviderBaseCost(activityId);

    const totalPaid = (window.providerPayments || []).reduce((sum, p) => {
        if (p.activityId === activityId) return sum + Number(p.amount || 0);
        return sum;
    }, 0);

    const remaining = Math.max(0, totalOwed - totalPaid);
    return { totalOwed, totalPaid, remaining, providerId, providerName };
}

function renderActivitiesTable() {
    const tbody = document.getElementById("activityTableBody");
    if (!tbody) return;

    tbody.innerHTML = "";

    if (!activities.length) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#777;">Sin actividades</td></tr>`;
        updateProviderSelects();
        return;
    }

    activities.forEach(a => {
        let totalBenefit = 0;
        students.forEach(st => {
            const sales = Array.isArray(st.sales) ? st.sales : [];
            sales.forEach(sa => {
                if (sa.activityId === a.id) totalBenefit += Number(sa.benefit || 0);
            });
        });

        const totals = getActivityProviderTotals(a.id);
        const providerName = totals.providerName || "-";

        tbody.innerHTML += `
        <tr>
            <td><strong>${a.name}</strong></td>
            <td>${providerName}</td>

            <td style="text-align:right; color:#2e7d32; font-weight:bold;">
                ${formatCurrency(totalBenefit)}
            </td>

            <td style="text-align:right; color:#d35400; font-weight:bold;">
                ${formatCurrency(totals.totalOwed)}
            </td>

            <td style="text-align:right; font-weight:bold; color:${totals.remaining > 0 ? '#c62828' : '#2e7d32'};">
                ${formatCurrency(totals.remaining)}
            </td>

            <td style="white-space:nowrap; text-align:center;">
                <button class="btn-edit" type="button" onclick="openActivityModal('${a.id}')">‚úèÔ∏è</button>

                <button class="btn-add" type="button" style="background:#17a2b8;"
                        onclick="openSalesModal('${a.id}')">üìà</button>

                <button class="btn-add" type="button" style="background:#2e7d32;"
                        onclick="openActivityPaymentsModal('${a.id}')">üí∂</button>

                <button class="btn-danger" type="button" onclick="deleteActivity('${a.id}')">üóëÔ∏è</button>
            </td>
        </tr>`;
    });

    updateProviderSelects();
}

function deleteActivity(id){
    if(!confirm("¬øEliminar actividad?")) return;
    activities = activities.filter(x=>x.id!==id);
    saveActivities();
    renderActivitiesTable();
    renderStudentsTable();
}

/* =====================================================
VENTAS POR ALUMNO (Beneficio + Coste proveedor)
===================================================== */
let currentSalesActivityId = null;

function openSalesModal(activityId) {
    currentSalesActivityId = activityId;
    const a = activities.find(x => x.id === activityId);
    if (!a) return;

    document.getElementById("salesActivityName").textContent = a.name;

    const tbody = document.getElementById("salesTableBody");
    tbody.innerHTML = "";

    students.forEach(st => {
        const sale = (a.sales || []).find(s => s.studentId === st.id) || {};
        const benefit = Number(sale.benefit || 0);
        const providerCost = Number(sale.providerCost || 0);

        tbody.innerHTML += `
        <tr>
            <td><strong>${st.name}</strong></td>

            <td>
                <input type="number" min="0" step="0.01"
                    class="sale-input"
                    data-id="${st.id}"
                    data-field="benefit"
                    value="${benefit}">
            </td>

            <td>
                <input type="number" min="0" step="0.01"
                    class="sale-input"
                    data-id="${st.id}"
                    data-field="providerCost"
                    value="${providerCost}">
            </td>

            <td class="sale-total" style="text-align:right;font-weight:bold;">
                ${(benefit + providerCost).toFixed(2)} ‚Ç¨
            </td>
        </tr>`;
    });

    document.querySelectorAll(".sale-input").forEach(input => {
        input.addEventListener("input", updateRowTotal);
    });

    openModal("salesModal");
}

function updateRowTotal(e) {
    const row = e.target.closest("tr");
    const id = e.target.dataset.id;

    const benefit = Number(row.querySelector(`[data-id="${id}"][data-field="benefit"]`).value) || 0;
    const providerCost = Number(row.querySelector(`[data-id="${id}"][data-field="providerCost"]`).value) || 0;

    row.querySelector(".sale-total").innerText = `${(benefit + providerCost).toFixed(2)} ‚Ç¨`;
}

function closeSalesModal() { closeModal("salesModal"); }

function saveSales() {
    const a = activities.find(x => x.id === currentSalesActivityId);
    if (!a) return;

    const salesMap = {};
    document.querySelectorAll(".sale-input").forEach(input => {
        const id = input.dataset.id;
        const field = input.dataset.field;
        const value = Number(input.value) || 0;

        if (!salesMap[id]) salesMap[id] = { studentId: id, benefit: 0, providerCost: 0 };
        salesMap[id][field] = value;
    });

    a.sales = Object.values(salesMap);

    a.sales.forEach(sale => {
        const st = students.find(x => x.id === sale.studentId);
        if (!st) return;

        if (!st.sales) st.sales = [];
        const existing = st.sales.find(d => d.activityId === currentSalesActivityId);

        if (existing) {
            existing.benefit = sale.benefit;
            existing.providerCost = sale.providerCost;
        } else {
            st.sales.push({
                activityId: currentSalesActivityId,
                benefit: sale.benefit,
                providerCost: sale.providerCost
            });
        }
    });

    saveActivities();
    saveStudents();
    renderActivitiesTable();
    renderStudentsTable();
    closeSalesModal();
}

/* =====================================================
PROVEEDORES
===================================================== */
let currentProviderId = null;

function openProviderModal(id = null) {
    currentProviderId = id;
    openModal("providerModal");

    const chk = document.getElementById("providerIsTrip");

    if (id) {
        const p = providers.find(x => x.id === id);
        if (!p) return;

        providerName.value = p.name || "";
        providerContact.value = p.contact || "";
        providerPhone.value = p.phone || "";
        chk.checked = !!p.isTripProvider;
    } else {
        providerName.value = "";
        providerContact.value = "";
        providerPhone.value = "";
        chk.checked = false;
    }
}

function closeProviderModal() { closeModal("providerModal"); }

function saveProvider() {
    const isTrip = document.getElementById("providerIsTrip").checked;

    const obj = {
        id: currentProviderId || ("prov" + Date.now()),
        name: providerName.value.trim(),
        contact: providerContact.value.trim(),
        phone: providerPhone.value.trim(),
        isTripProvider: isTrip
    };

    if (!obj.name) return alert("Nombre requerido");

    if (isTrip) {
        providers.forEach(p => p.isTripProvider = false);
        obj.isTripProvider = true;
    }

    if (currentProviderId) {
        const i = providers.findIndex(x => x.id === currentProviderId);
        providers[i] = obj;
    } else {
        providers.push(obj);
    }

    saveProviders();
    closeProviderModal();
    renderProvidersTable();
    updateProviderSelects();
}

function deleteProvider(id) {
    if (!confirm("¬øEliminar proveedor?")) return;
    providers = providers.filter(x => x.id !== id);
    saveProviders();
    renderProvidersTable();
    updateProviderSelects();
}

function renderProvidersTable() {
    const tbody = document.getElementById("providerTableBody");
    if (!tbody) return;

    tbody.innerHTML = "";

    if (!providers.length) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Sin proveedores</td></tr>`;
        updateProviderSelects();
        return;
    }

    const allPayments = Array.isArray(window.providerPayments) ? window.providerPayments : [];

    providers.forEach(p => {
        let totalCost = 0;

        activities
            .filter(a => a.providerId === p.id)
            .forEach(a => {
                students.forEach(st => {
                    const sales = Array.isArray(st.sales) ? st.sales : [];
                    sales.forEach(sa => {
                        if (sa.activityId === a.id) totalCost += Number(sa.providerCost || 0);
                    });
                });
            });

        const paid = allPayments
            .filter(pay => pay.providerId === p.id)
            .reduce((sum, pay) => sum + Number(pay.amount || 0), 0);

        const remaining = Math.max(0, totalCost - paid);

        tbody.innerHTML += `
        <tr>
            <td>${p.name}</td>
            <td>${p.contact || "-"}</td>
            <td>${p.phone || "-"}</td>
            <td style="color:#e67e22; font-weight:bold;">
                ${formatCurrency(remaining)}
            </td>
            <td>
                <button type="button" onclick="openProviderModal('${p.id}')" class="btn-edit">‚úèÔ∏è</button>
                <button type="button" onclick="deleteProvider('${p.id}')" class="btn-danger">üóëÔ∏è</button>
            </td>
        </tr>`;
    });

    updateProviderSelects();
}
/* =====================================================
SELECTS PROVEEDORES/ACTIVIDADES
===================================================== */
function updateProviderSelects() {
    const selectActivityProvider = document.getElementById("activityProvider");
    if (selectActivityProvider) {
        selectActivityProvider.innerHTML = `
            <option value="">Seleccionar proveedor...</option>
            ${providers.map(p => `<option value="${p.id}">${p.name}</option>`).join("")}
        `;
    }

    const selectPayProv = document.getElementById("paymentsProviderFilter");
    if (selectPayProv) {
        const current = selectPayProv.value;
        selectPayProv.innerHTML = `
            <option value="all">Todos</option>
            ${providers.map(p => `<option value="${p.id}">${p.name}</option>`).join("")}
        `;
        if (current) selectPayProv.value = current;
    }

    const selectPayAct = document.getElementById("paymentsActivityFilter");
    if (selectPayAct) {
        const current = selectPayAct.value;
        selectPayAct.innerHTML = `
            <option value="all">Todas</option>
            ${activities.map(a => `<option value="${a.id}">${a.name}</option>`).join("")}
        `;
        if (current) selectPayAct.value = current;
    }
}

/* =====================================================
PAGOS ALUMNO
===================================================== */
function openPaymentModal(studentId){
    const s = students.find(st => st.id === studentId);
    if (!s) return alert("Alumno no encontrado");

    openModal("paymentModal");

    document.getElementById("studentPaymentName").textContent = s.name;

    document.getElementById("studentPaymentDate").value = new Date().toISOString().slice(0,10);
    document.getElementById("studentPaymentAmount").value = "";
    document.getElementById("studentPaymentMethod").value = "Efectivo";
    document.getElementById("studentPaymentNotes").value = "";

    const tbody = document.getElementById("paymentHistoryTable");
    tbody.innerHTML = "";

    if (!s.payments || !s.payments.length){
        tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;color:#888;">Sin pagos</td></tr>`;
    } else {
        s.payments.forEach(p => {
            tbody.innerHTML += `
                <tr>
                    <td>${p.date}</td>
                    <td>${formatCurrency(Number(p.amount||0))}</td>
                    <td>${p.method || "-"}</td>
                </tr>`;
        });
    }

    window.currentPaymentStudentId = studentId;
}

function closePaymentModal(){ closeModal("paymentModal"); }

function savePayment(){
    const id = window.currentPaymentStudentId;
    const s = students.find(st => st.id === id);
    if (!s) return alert("Alumno no encontrado");

    const date = document.getElementById("studentPaymentDate").value;
    const amount = Number(document.getElementById("studentPaymentAmount").value || "0");
    const method = document.getElementById("studentPaymentMethod").value;
    const notes = document.getElementById("studentPaymentNotes").value.trim();

    if (!isFinite(amount) || amount <= 0){
        alert("Introduce un importe v√°lido");
        return;
    }

    s.payments = Array.isArray(s.payments) ? s.payments : [];
    s.payments.push({
        id: "pay_" + Date.now(),
        date,
        amount,
        method,
        notes
    });

    saveStudents();
    renderStudentsTable();
    updateDashboard();
    closePaymentModal();
}

/* ==========================================================
Formateo moneda
==========================================================*/
function formatCurrency(num){
    const n = Number(num || 0);
    return n.toLocaleString('es-ES',{
        minimumFractionDigits:2,
        maximumFractionDigits:2
    }) + " ‚Ç¨";
}

/* =====================================================
parseEuroNumber
===================================================== */
function parseEuroNumber(str) {
    if (str == null) return NaN;
    str = String(str).trim();
    if (!str) return NaN;

    str = str.replace(/\s/g, "");

    const commaPos = str.lastIndexOf(",");
    const dotPos   = str.lastIndexOf(".");

    if (commaPos !== -1 && dotPos !== -1) {
        if (commaPos > dotPos) {
            str = str.replace(/\./g, "").replace(",", ".");
        } else {
            str = str.replace(/,/g, "");
        }
    } else if (commaPos !== -1) {
        str = str.replace(",", ".");
    } else if (dotPos !== -1) {
        const parts = str.split(".");
        if (parts.length > 2) {
            const decimal = parts.pop();
            str = parts.join("") + "." + decimal;
        }
    }
    return Number(str);
}

/* ==========================================================
DASHBOARD
==========================================================*/
let donutChart = null;
let barRankingChart = null;

function updateDashboard(){
    const tripCost = baseTripCost + extraTripCost;
    let totalCollected = 0;
    let completedCount = 0;

    let rankingData = students.map(st=>{
        const benefit = (st.sales||[]).reduce((a,b)=>a+(Number(b.benefit)||0),0);
        const payments = (st.payments||[]).reduce((a,b)=>a+(Number(b.amount)||0),0);

        const total = benefit + payments;
        totalCollected += total;

        const pending = tripCost - total;
        if(pending <= 0) completedCount++;

        const percent = Math.max(0,Math.min(100,(total/tripCost)*100));

        return {
            name: st.name,
            total,
            percent,
            isComplete: pending <= 0
        };
    });

    const pendingGroup = Math.max(0,(tripCost * students.length) - totalCollected);
    const percentGroup = Math.round((totalCollected / (tripCost * students.length)) * 100) || 0;

    document.getElementById("kpiTotal").innerText     = formatCurrency(totalCollected);
    document.getElementById("kpiPending").innerText   = formatCurrency(pendingGroup);
    document.getElementById("kpiPercent").innerText   = percentGroup + "%";
    document.getElementById("kpiCompleted").innerText = completedCount;

    const donutCanvas = document.getElementById("donutChart");
    if(donutCanvas){
        if(donutChart) donutChart.destroy();
        donutChart = new Chart(donutCanvas,{
            type:"doughnut",
            data:{
                labels:["Recaudado","Pendiente"],
                datasets:[{
                    data:[totalCollected,pendingGroup],
                    backgroundColor:["#8FD5A6","#FFB5A7"]
                }]
            },
            options:{
                plugins:{
                    tooltip:{ callbacks:{ label:(ctx)=> formatCurrency(ctx.raw) } },
                    legend:{ position:"bottom" }
                },
                animation:{ animateScale:true },
                responsive:true
            }
        });
    }

    rankingData.sort((a,b)=>b.total - a.total);
    const barCanvas = document.getElementById("barRanking");
    if(barCanvas){
        barCanvas.height = rankingData.length * 28;

        if(barRankingChart) barRankingChart.destroy();
        barRankingChart = new Chart(barCanvas,{
            type:"bar",
            data:{
                labels:rankingData.map(r=>r.name),
                datasets:[{
                    data: rankingData.map(r=>r.total),
                    backgroundColor: rankingData.map(r => r.isComplete ? "#8FD5A6" : "#9BBCE0")
                }]
            },
            options:{
                indexAxis:'y',
                responsive:true,
                maintainAspectRatio:false,
                plugins:{
                    legend:{display:false},
                    tooltip:{ callbacks:{ label:(ctx)=> formatCurrency(ctx.raw) } }
                },
                scales:{
                    x:{ ticks:{ callback:v=>formatCurrency(v) } },
                    y:{ ticks:{ autoSkip:false, font:{ size:11 } } }
                }
            }
        });
    }

    updateDashboardPayments();
}

/* =====================================================
PAGOS PENDIENTES DASHBOARD
===================================================== */
function updateDashboardPayments(){
    const container = document.getElementById("dashboardPaymentsContainer");
    if (!container) return;

    if (!Array.isArray(window.providerPayments)) window.providerPayments = [];

    container.innerHTML = "";

    const pendingList = [];

    activities.forEach(act => {
        if (!act.providerId) return;

        const provider = providers.find(p => p.id === act.providerId);
        const provName = provider ? provider.name : "-";

        const baseCost = getActivityProviderBaseCost(act.id);

        const paysAct = (window.providerPayments || []).filter(p => p.activityId === act.id);
        const paidAct = paysAct.reduce((s,p)=>s+(Number(p.amount)||0),0);
        const pendingAct = Math.max(0, baseCost - paidAct);

        if (pendingAct > 0){
            const urgency =
                pendingAct >= baseCost * 0.50 ? "urgent" :
                pendingAct >= baseCost * 0.25 ? "soon" : "ok";

            pendingList.push({
                providerId: act.providerId,
                providerName: provName,
                activityId: act.id,
                activityName: act.name || "-",
                pending: pendingAct,
                baseCost,
                urgency
            });
        }
    });

    if (!pendingList.length){
        container.innerHTML = `
            <div style="text-align:center;color:#22a122;padding:15px;font-weight:bold;">
                ‚úî Todo al d√≠a ‚Äî No hay pagos pendientes
            </div>`;
        return;
    }

    pendingList.sort((a,b)=>{
        const urgencyRank = { urgent:3, soon:2, ok:1 };
        return urgencyRank[b.urgency] - urgencyRank[a.urgency] || b.pending - a.pending;
    });

    container.innerHTML = pendingList.map(p => {
        const bg = p.urgency === "urgent" ? "#ffebee" : (p.urgency === "soon" ? "#fff3e0" : "#e8f5e9");
        const color = p.urgency === "urgent" ? "#c62828" : (p.urgency === "soon" ? "#ef6c00" : "#2e7d32");

        return `
        <div class="card" style="padding:12px;margin-bottom:10px;background:${bg}; border-left:6px solid ${color};">
            <div style="color:${color};font-weight:bold;font-size:1rem;">${p.activityName}</div>
            <div style="font-size:0.85rem;margin-bottom:6px;">
                Proveedor: <strong>${p.providerName}</strong>
            </div>
            <div style="margin-top:6px;font-size:1.1rem;color:${color};">
                Pendiente: <strong>${formatCurrency(p.pending)}</strong>
            </div>
            <div style="text-align:right;margin-top:8px;">
                <button class="btn-success" type="button"
                    onclick="openPaymentForActivity('${p.providerId}','${p.activityId}')"
                    style="padding:6px 12px;font-size:0.8rem;">
                    üí∏ Pagar ahora
                </button>
            </div>
        </div>`;
    }).join("");
}

function openPaymentForActivity(providerId, activityId){
    document.querySelector('[data-section="payments"]')?.click();
    setTimeout(()=>{
        const selProv = document.getElementById("paymentsProviderFilter");
        const selAct  = document.getElementById("paymentsActivityFilter");
        if (selProv) selProv.value = providerId;
        if (selAct)  selAct.value  = activityId;
        updatePaymentsView();
    }, 250);
}
/* =====================================================
MODAL PAGOS PROVEEDOR POR ACTIVIDAD
===================================================== */
let currentPaymentsActivityId = null;

function openActivityPaymentsModal(activityId){
    const activity = activities.find(a => a.id === activityId);
    if (!activity) { alert("Actividad no encontrada"); return; }

    currentPaymentsActivityId = activityId;

    const totals = getActivityProviderTotals(activityId);

    document.getElementById("activityPaymentsInfo").innerHTML = `
        <strong>Actividad:</strong> ${activity.name}<br>
        <strong>Proveedor:</strong> ${totals.providerName}<br>
        <strong>Coste total proveedor:</strong> ${formatCurrency(totals.totalOwed)}<br>
        <strong>Pagado:</strong> ${formatCurrency(totals.totalPaid)}<br>
        <strong>Pendiente:</strong>
            <span style="color:${totals.remaining > 0 ? 'red' : 'green'};">
                ${formatCurrency(totals.remaining)}
            </span>
    `;

    document.getElementById("providerPayAmount").value = "";
    document.getElementById("providerPayConcept").value = "";
    document.getElementById("providerPayMethod").value = "Transferencia";
    document.getElementById("providerPayDate").value = new Date().toISOString().slice(0,10);

    openModal("activityPaymentsModal");
    refreshActivityPaymentsTable();
}

function closeActivityPaymentsModal(){ closeModal("activityPaymentsModal"); }

function refreshActivityPaymentsTable() {
    const tbody = document.getElementById("providerPaymentsTableBody");
    if (!tbody) return;

    const activityId = currentPaymentsActivityId;
    if (!activityId) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#777;">No hay actividad seleccionada.</td></tr>`;
        return;
    }

    const pagos = (window.providerPayments || [])
        .filter(p => p.activityId === activityId)
        .sort((a,b) => (a.date || "").localeCompare(b.date || ""));

    if (!pagos.length) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#777;">Sin pagos registrados</td></tr>`;
        return;
    }

    tbody.innerHTML = pagos.map(p => `
        <tr>
            <td>${p.date || "-"}</td>
            <td>${p.concept || "-"}</td>
            <td>${p.method || "-"}</td>
            <td style="text-align:right;">${formatCurrency(p.amount || 0)}</td>
            <td style="text-align:center;">
                <button class="btn-danger" type="button" style="padding:3px 8px;"
                    onclick="deleteProviderPayment('${p.id}')">üóëÔ∏è</button>
            </td>
        </tr>
    `).join("");
}

function deleteProviderPayment(paymentId){
    if (!confirm("¬øEliminar este pago definitivamente?")) return;
    window.providerPayments = (window.providerPayments || []).filter(p => p.id !== paymentId);
    saveProviderPayments();

    refreshActivityPaymentsTable();
    renderActivitiesTable();
    updateDashboardPayments();
    updatePaymentsView();
}

function registerProviderPayment() {
    const activity = activities.find(a => a.id === currentPaymentsActivityId);
    if (!activity){ alert("Actividad no encontrada."); return; }

    const date = (document.getElementById("providerPayDate").value || new Date().toISOString().slice(0,10)).trim();
    const concept = (document.getElementById("providerPayConcept").value || "").trim();
    const rawAmount = (document.getElementById("providerPayAmount").value || "").trim();
    const amount = parseEuroNumber(rawAmount);

    if (!isFinite(amount) || amount <= 0){
        alert("Introduce un importe v√°lido (7032,58 o 7032.58).");
        return;
    }

    const method = document.getElementById("providerPayMethod").value || "Transferencia";
    const totals = getActivityProviderTotals(activity.id);

    if (amount > totals.remaining + 0.01){
        if (!confirm(`‚ö†Ô∏è El importe (${formatCurrency(amount)}) supera la deuda pendiente (${formatCurrency(totals.remaining)}). ¬øRegistrar igualmente?`)) return;
    }

    window.providerPayments = Array.isArray(window.providerPayments) ? window.providerPayments : [];
    window.providerPayments.push({
        id: "provPay_" + Date.now(),
        activityId: activity.id,
        providerId: activity.providerId || null,
        date,
        concept: concept || "Pago proveedor actividad",
        method,
        amount
    });

    saveProviderPayments();

    document.getElementById("providerPayAmount").value = "";

    refreshActivityPaymentsTable();
    renderActivitiesTable();
    updateDashboardPayments();
    updatePaymentsView();
}

function payActivityFullDebt(){
    if (!currentPaymentsActivityId){ alert("No hay actividad seleccionada."); return; }

    const totals = getActivityProviderTotals(currentPaymentsActivityId);
    if (!totals || totals.remaining <= 0){ alert("No hay deuda pendiente."); return; }

    if (!confirm(`Se registrar√° un pago TOTAL por: ${formatCurrency(totals.remaining)}`)) return;

    window.providerPayments.push({
        id: "provPay_" + Date.now(),
        activityId: currentPaymentsActivityId,
        providerId: totals.providerId,
        date: new Date().toISOString().slice(0,10),
        concept: "Pago total proveedor",
        method: "Transferencia",
        amount: totals.remaining
    });

    saveProviderPayments();
    refreshActivityPaymentsTable();
    renderActivitiesTable();
    updateDashboardPayments();
    updatePaymentsView();
}

/* =====================================================
PAGOS A PROVEEDORES ‚Äî VISTA
===================================================== */
function fillPendingAmount(e){
    if (e) e.preventDefault();

    const activityId = document.getElementById("paymentsActivityFilter").value;
    if (activityId === "all"){
        alert("Selecciona una actividad.");
        return;
    }

    const totals = getActivityProviderTotals(activityId);
    document.getElementById("providerPayAmount").value = (Number(totals.remaining || 0)).toFixed(2);

    // abre directamente el modal de la actividad seleccionada
    openActivityPaymentsModal(activityId);
}

function updatePaymentsView(){
    const kpiContainer   = document.getElementById("paymentsSummaryKPI");
    const tableContainer = document.getElementById("paymentsTableContainer");
    if (!kpiContainer || !tableContainer) return;

    window.providerPayments = Array.isArray(window.providerPayments) ? window.providerPayments : [];

    const providerId = document.getElementById("paymentsProviderFilter")?.value || "all";
    const activityId = document.getElementById("paymentsActivityFilter")?.value || "all";

    const activitiesScope = activities.filter(act => {
        if (activityId !== "all" && act.id !== activityId) return false;
        if (providerId !== "all" && act.providerId !== providerId) return false;
        return true;
    });

    let baseCost = 0;
    activitiesScope.forEach(act => baseCost += getActivityProviderBaseCost(act.id));

    const pays = window.providerPayments.filter(p => {
        if (providerId !== "all" && p.providerId !== providerId) return false;
        if (activityId !== "all" && p.activityId !== activityId) return false;
        return true;
    });

    const totalPaid = pays.reduce((s,p)=>s + Number(p.amount||0), 0);
    const pending   = Math.max(0, baseCost - totalPaid);

    kpiContainer.innerHTML = `
        <div class="kpi-card pastel-card">
            Importe previsto<br>
            <strong>${formatCurrency(baseCost)}</strong>
        </div>
        <div class="kpi-card pastel-card">
            Pagado<br>
            <strong>${formatCurrency(totalPaid)}</strong>
        </div>
        <div class="kpi-card pastel-card">
            Pendiente<br>
            <strong>${formatCurrency(pending)}</strong>
        </div>
    `;

    if (!pays.length){
        tableContainer.innerHTML = `<p style="text-align:center;color:#888;">No hay pagos registrados para los filtros seleccionados</p>`;
        return;
    }

    const rows = pays.map((p,idx)=>{
        const provName = providers.find(pr => pr.id === p.providerId)?.name || "-";
        const actName  = activities.find(ac => ac.id === p.activityId)?.name || "-";
        const bg   = idx % 2 === 0 ? "#fff" : "#f7f7f7";

        return `
        <tr style="background:${bg};">
            <td>${p.date || "-"}</td>
            <td>${provName}</td>
            <td>${actName}</td>
            <td>${p.concept || "-"}</td>
            <td style="text-align:right;">${formatCurrency(p.amount || 0)}</td>
            <td style="text-align:center;">
                <button class="btn-danger" type="button" style="padding:4px 8px;"
                    onclick="deleteProviderPayment('${p.id}')">üóëÔ∏è</button>
            </td>
        </tr>`;
    });

    tableContainer.innerHTML = `
        <table class="report-table" style="width:100%;">
          <thead>
            <tr style="background:#e3f2fd;">
                <th>Fecha</th>
                <th>Proveedor</th>
                <th>Actividad</th>
                <th>Concepto</th>
                <th style="text-align:right;">Importe</th>
                <th style="text-align:center;">Acciones</th>
            </tr>
          </thead>
          <tbody>${rows.join("")}</tbody>
        </table>
    `;
}

/* =====================================================
EXPORT / IMPORT BACKUP
===================================================== */
function exportData() {
    const backup = {
        version: 1,
        date: new Date().toISOString(),
        students: students || [],
        activities: activities || [],
        providers: providers || [],
        providerPayments: window.providerPayments || []
    };

    const json = JSON.stringify(backup, null, 2);
    const blob = new Blob([json], { type: "application/json" });

    const fileName = "Backup_Viaje_" + new Date().toISOString().slice(0, 10) + ".json";

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = fileName;
    a.style.display = "none";
    document.body.appendChild(a);
    a.click();

    URL.revokeObjectURL(url);
    a.remove();

    alert("üìÅ Copia de seguridad generada con √©xito");
    closeModal("exportModal");
}

function importData() {
    const file = document.getElementById("importFile")?.files?.[0];
    if (!file) return alert("Selecciona un archivo JSON");

    const reader = new FileReader();
    reader.onload = e => {
        try {
            const obj = JSON.parse(e.target.result);

            if (!obj.students || !obj.activities || !obj.providers)
                return alert("‚ùå Archivo no compatible");

            students = (obj.students || []).map(s => ({
                ...s,
                sales: Array.isArray(s.sales) ? s.sales : [],
                payments: Array.isArray(s.payments) ? s.payments : []
            }));

            activities = Array.isArray(obj.activities) ? obj.activities : [];
            providers  = Array.isArray(obj.providers) ? obj.providers : [];

            window.providerPayments = Array.isArray(obj.providerPayments) ? obj.providerPayments : [];

            saveStudents();
            saveActivities();
            saveProviders();
            saveProviderPayments();

            updateProviderSelects();
            renderStudentsTable();
            renderActivitiesTable();
            renderProvidersTable();
            updatePaymentsView();
            updateDashboard();

            alert("‚úÖ Datos importados y cargados");
            closeModal("importModal");
        } catch (err) {
            console.error(err);
            alert("‚ö†Ô∏è Error leyendo archivo");
        }
    };
    reader.readAsText(file);
}
/* =====================================================
üìä INFORMES - Control de vistas (VERSI√ìN FINAL ESTABLE)
===================================================== */
function showReportView(view) {
    const container = document.getElementById("reportViewContainer");
    if (!container) return;
    container.innerHTML = "";

    /* üåç INFORME GLOBAL DEL VIAJE */
    if (view === "global") {
        container.innerHTML = `
            <div class="report-header">
                <h2>Situaci√≥n Global del Viaje</h2>
                <button class="btn-pdf" id="btnExportGlobalPDF">üìÑ Exportar PDF</button>
            </div>

            <div id="kpiContainerReports" class="kpi-grid"></div>

            <div class="global-grid">
                <div class="chart-card">
                    <h3 class="chart-title">Situaci√≥n general</h3>
                    <canvas id="donutChartReports"></canvas>
                </div>

                <div class="chart-card" style="overflow-y:auto;">
                    <h3 class="chart-title">Ranking de aportaciones</h3>
                    <table class="report-table">
                        <thead>
                            <tr><th>Alumno</th><th>Aportado</th><th>%</th></tr>
                        </thead>
                        <tbody id="rankingTableBody"></tbody>
                    </table>
                </div>
            </div>
        `;

        setTimeout(() => {
            updateReportsDashboard();
            document.getElementById("btnExportGlobalPDF")?.addEventListener("click", exportGlobalPDF);
        }, 150);

        return;
    }

    /* üë®‚Äçüéì INFORME TOTAL ALUMNOS */
    if (view === "studentsTotal") {
        container.innerHTML = `
            <div class="report-header">
                <h2>Informe Total de Alumnos</h2>
                <button id="btnExportStudentsTotalPDF" class="btn-pdf">üìÑ Exportar PDF</button>
            </div>

            <input id="searchStudentReport" type="text"
                placeholder="üîç Buscar alumno..."
                class="report-filter-select"
                oninput="filterStudentsReport()">

            <div class="chart-card" style="overflow-x:auto;">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Alumno</th>
                            <th>Clase</th>
                            <th>Aportado</th>
                            <th>Pendiente</th>
                            <th>%</th>
                            <th>OK</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTotalTableBody"></tbody>
                </table>
            </div>
        `;

        setTimeout(() => {
            updateStudentsTotalReport();
            document.getElementById("btnExportStudentsTotalPDF")
                ?.addEventListener("click", exportStudentsTotalPDF);
        }, 150);
        return;
    }

    /* üë§ INFORME INDIVIDUAL ALUMNO */
    if (view === "studentSingle") {
        container.innerHTML = `
            <div class="report-header">
                <h2>Informe por Alumno</h2>
                <button id="btnExportStudentPDF" class="btn-success">üìÑ Exportar PDF</button>
                <button id="btnExportAllStudentsZIP" class="btn-add">üóÇÔ∏è Exportar TODOS (ZIP)</button>
            </div>

            <div class="report-filter-box">
                <label><strong>Alumno:</strong></label>
                <select id="selectStudentReport" class="report-filter-select"
                    onchange="showStudentReportDetails()">
                    <option value="">Seleccione...</option>
                    ${students.map(s => `<option value="${s.id}">${s.name}</option>`).join("")}
                </select>
            </div>

            <div class="chart-card">
                <label><strong>Datos a incluir:</strong></label>
                <div class="grid-2">
                    <label><input id="chkGeneral" type="checkbox" checked> Generales</label>
                    <label><input id="chkHealth" type="checkbox" checked> Salud</label>
                    <label><input id="chkPayments" type="checkbox"> Pagos</label>
                    <label><input id="chkActivities" type="checkbox"> Actividades</label>
                </div>
            </div>

            <div id="studentDetailsContainer" class="chart-card">
                <p><i>Seleccione un alumno...</i></p>
            </div>
        `;

        setTimeout(() => {
    ["chkGeneral","chkHealth","chkPayments","chkActivities"].forEach(id => {
        document.getElementById(id)?.addEventListener("change", showStudentReportDetails);
    });

    document.getElementById("btnExportStudentPDF")
        ?.addEventListener("click", exportStudentPDF);

    // üóÇÔ∏è ZIP todos los alumnos
    document.getElementById("btnExportAllStudentsZIP")
        ?.addEventListener("click", exportAllStudentsZIP);
}, 150);
return;
}

    /* üßÆ INFORME ACTIVIDAD POR ALUMNO */
    if (view === "studentsActivity") {
        container.innerHTML = `
            <div class="report-header">
                <h2>Actividad por Alumno</h2>
                <button id="btnExportStudentActivityPDF" class="btn-pdf">üìÑ Exportar PDF</button>
            </div>

            <div class="report-filter-box">
                <label><strong>Alumno:</strong></label>
                <select id="selectStudentActivityStudent"
                    class="report-filter-select"
                    onchange="updateStudentActivityReport()">
                    <option value="all">Todos</option>
                    ${students.map(s => `<option value="${s.id}">${s.name}</option>`).join("")}
                </select>
            </div>

            <div class="report-filter-box">
                <label><strong>Actividad:</strong></label>
                <select id="selectStudentActivityActivity"
                    class="report-filter-select"
                    onchange="updateStudentActivityReport()">
                    <option value="all">Todas</option>
                    ${activities.map(a => `<option value="${a.id}">${a.name}</option>`).join("")}
                </select>
            </div>

            <div id="studentActivityReportContainer" class="chart-card"></div>
        `;

        setTimeout(() => {
            updateStudentActivityReport();
            document.getElementById("btnExportStudentActivityPDF")
                ?.addEventListener("click", exportStudentActivityPDF);
        }, 150);
        return;
    }

    /* üì¶ INFORME ACTIVIDADES */
    if (view === "activities") {
        container.innerHTML = `
            <div class="report-header">
                <h2>Informe de Actividades</h2>
                <button id="btnExportActivityPDF" class="btn-pdf">üìÑ Exportar PDF</button>
            </div>

            <div class="report-filter-box">
                <label><strong>Actividad:</strong></label>
                <select id="selectActivityReport" class="report-filter-select"
                    onchange="updateActivitiesReport()">
                    <option value="all">Todas</option>
                    ${activities.map(a => `<option value="${a.id}">${a.name}</option>`).join("")}
                </select>
            </div>

            <div id="activitiesReportContainer" class="chart-card"></div>
        `;

        setTimeout(() => {
            updateActivitiesReport();
            document.getElementById("btnExportActivityPDF")
                ?.addEventListener("click", exportActivitiesPDF);
        }, 150);
        return;
    }

    /* ü§ù INFORME PROVEEDORES */
    if (view === "providers") {
        container.innerHTML = `
            <div class="report-header">
                <h2>Informe de Proveedores</h2>
                <button id="btnExportProvidersPDF" class="btn-pdf">üìÑ Exportar PDF</button>
            </div>

            <div class="report-filter-box">
                <label><strong>Proveedor:</strong></label>
                <select id="selectProvidersReport" class="report-filter-select">
                    <option value="all">Todos</option>
                    ${providers.map(p => `<option value="${p.id}">${p.name}</option>`).join("")}
                </select>
            </div>

            <div id="providersReportContainer" class="chart-card"></div>
        `;

        setTimeout(() => {
            const select = document.getElementById("selectProvidersReport");
            select?.addEventListener("change", () => {
                updateProvidersReport();
                enableOrDisableProvidersPDF();
            });

            updateProvidersReport();
            enableOrDisableProvidersPDF();

            document.getElementById("btnExportProvidersPDF")
                ?.addEventListener("click", exportProvidersPDF);
        }, 150);
        return;
    }

    /* üí∏ INFORME GLOBAL PAGOS A PROVEEDORES */
    if (view === "payments") {
        container.innerHTML = `
            <div class="report-header">
                <h2>Pagos Globales a Proveedores</h2>
                <button id="btnExportPaymentsPDF" class="btn-pdf">üìÑ Exportar PDF</button>
            </div>

            <div id="paymentsGlobalContainer" class="chart-card"></div>
        `;

        setTimeout(() => {
            updatePaymentsGlobalReport();
            document.getElementById("btnExportPaymentsPDF")
                ?.addEventListener("click", exportPaymentsGlobalPDF);
        }, 150);
        return;
    }
}

/* =====================================================
üìå getTripData() ‚Äî datos reales del viaje desde students.sales
- Busca proveedor "AUTOCARES NAVARRO" (case-insensitive)
- Fallback id 'prov1765409413706'
===================================================== */
function getTripData() {
    const tripProvider =
        (Array.isArray(providers) && providers.find(p => /autocares\s*navarro/i.test(p.name))) ||
        (Array.isArray(providers) && providers.find(p => p.id === 'prov1765409413706')) ||
        null;

    if (!tripProvider) return { valid: false, message: "Proveedor de viaje no encontrado." };

    const providerId = tripProvider.id;

    const tripActivities = Array.isArray(activities) ? activities.filter(a => a.providerId === providerId) : [];
    const tripActivityIds = tripActivities.map(a => a.id);

    const allStudents = Array.isArray(students) ? students : [];
    const allProviderPayments = Array.isArray(window.providerPayments) ? window.providerPayments : [];

    let totalTripCost = 0;
    let totalBenefit = 0;
    let totalStudentPayments = 0;
    let totalProviderPayments = 0;

    totalProviderPayments = allProviderPayments
        .filter(pp => pp.providerId === providerId)
        .reduce((s, p) => s + Number(p.amount || p.cantidad || 0), 0);

    const studentsData = allStudents.map(st => {
        const sales = Array.isArray(st.sales) ? st.sales : [];
        const payments = Array.isArray(st.payments) ? st.payments : [];

        let tripCost = 0;
        let benefit = 0;

        sales.forEach(sa => {
            benefit += Number(sa.benefit || 0);
            if (tripActivityIds.includes(sa.activityId)) {
                tripCost += Number(sa.providerCost || 0);
            }
        });

        const studentPayments = payments.reduce((s, r) => s + Number(r.amount || r.cantidad || 0), 0);

        totalTripCost += tripCost;
        totalBenefit += benefit;
        totalStudentPayments += studentPayments;

        const totalCovered = benefit + studentPayments;
        const pending = tripCost - totalCovered;
        const percent = tripCost > 0 ? Math.round((totalCovered / tripCost) * 100) : 0;

        return {
            id: st.id,
            name: st.name,
            tripCost,
            benefit,
            studentPayments,
            totalCovered,
            pending,
            percent
        };
    });

    const tripCostPerStudent = studentsData.length ? (totalTripCost / studentsData.length) : 0;
    const totalCoveredOverall = totalBenefit + totalStudentPayments;

    const pendingByProviderPayments = Math.max(0, totalTripCost - totalProviderPayments);
    const pendingByBenefits = totalTripCost - totalBenefit;

    return {
        valid: true,
        provider: { id: providerId, name: tripProvider.name },
        studentsData,
        totalTripCost,
        totalBenefit,
        totalStudentPayments,
        totalProviderPayments,
        totalCoveredOverall,
        tripCostPerStudent,
        pendingByProviderPayments,
        pendingByBenefits
    };
}
/* =====================================================
üìä updateReportsDashboard() ‚Äî actualiza la vista global
===================================================== */
function updateReportsDashboard() {
    const kpiContainer = document.getElementById("kpiContainerReports");
    const rankingBody  = document.getElementById("rankingTableBody");
    const canvasId     = "donutChartReports";

    if (!kpiContainer || !rankingBody) return;

    const data = getTripData();
    if (!data || !data.valid) {
        kpiContainer.innerHTML = `<div style="color:#c62828;padding:10px 0;">
            ‚ö†Ô∏è ${data && data.message ? data.message : "No hay datos de viaje configurados."}
        </div>`;
        rankingBody.innerHTML = "";
        const c = document.getElementById(canvasId);
        if (c && c._chartInstance) { try { c._chartInstance.destroy(); } catch(e){} }
        return;
    }

    const costPerStudent = data.tripCostPerStudent;
    const benefits = data.totalBenefit;
    const pending = data.pendingByProviderPayments;
    const pendingColor = pending > 0 ? "#c62828" : "#2e7d32";

    kpiContainer.innerHTML = `
        <div class="kpi-card pastel-card">
            <span style="font-size:18px;">üí∞ Coste viaje por alumno</span><br>
            <strong style="font-size:18px;">${formatCurrency(costPerStudent)}</strong>
        </div>
        <div class="kpi-card pastel-card">
            <span style="font-size:18px;">üì¶ Beneficios generados</span><br>
            <strong style="font-size:18px;">${formatCurrency(benefits)}</strong>
        </div>
        <div class="kpi-card pastel-card">
            <span style="font-size:18px;">‚è≥ Pendiente total</span><br>
            <strong style="font-size:18px;color:${pendingColor};">${formatCurrency(pending)}</strong>
        </div>
    `;

    const ranking = (data.studentsData || []).slice().sort((a,b) => (b.totalCovered||0) - (a.totalCovered||0));
    rankingBody.innerHTML = ranking.map(s => `
        <tr>
            <td>${s.name}</td>
            <td style="text-align:right;">${formatCurrency(s.totalCovered)}</td>
            <td style="text-align:right;">${(typeof s.percent === "number" ? s.percent : 0)}%</td>
        </tr>
    `).join("");

    const covered = data.totalCoveredOverall;
    const remainingByCovered = Math.max(0, data.totalTripCost - covered);

    try {
        const canvas = document.getElementById(canvasId);
        if (canvas) {
            if (canvas._chartInstance) { try { canvas._chartInstance.destroy(); } catch (e) {} }

            const ctx = canvas.getContext("2d");
            const chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Cubierto (beneficios+pagos alumnos)', 'Pendiente'],
                    datasets: [{
                        data: [covered, remainingByCovered],
                        backgroundColor: ['#2e7d32', '#c62828'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '60%',
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: { callbacks: { label: (c) => `${c.label}: ${formatCurrency(c.parsed)}` } }
                    }
                }
            });
            canvas._chartInstance = chart;
        }
    } catch (err) {
        console.warn("Error dibujando donut:", err);
    }
}

/* =====================================================
üìä INFORME TOTAL ALUMNOS (tabla)
===================================================== */
function updateStudentsTotalReport(){
    const tbody = document.getElementById("studentsTotalTableBody");
    if(!tbody) return;
    tbody.innerHTML = "";

    const tripCost = baseTripCost + extraTripCost;

    students
        .slice()
        .sort((a,b)=>String(a.name||"").localeCompare(String(b.name||"")))
        .forEach((st, i)=>{
            const benefit = (st.sales||[]).reduce((a,b)=>a+(Number(b.benefit)||0),0);
            const payments = (st.payments||[]).reduce((a,b)=>a+(Number(b.amount)||0),0);
            const total = benefit + payments;
            const pending = Math.max(0, tripCost-total);
            const percent = tripCost>0 ? Math.round((total/tripCost)*100) : 0;

            tbody.innerHTML += `
            <tr class="${pending<=0 ? "complete-row" : ""}"
                style="background:${i%2==0 ? '#ffffff':'#f7f7f7'};">
                <td><strong>${st.name||""}</strong></td>
                <td style="text-align:center;">${st.class||"-"}</td>
                <td style="text-align:right;">${formatCurrency(total)}</td>
                <td style="text-align:right;color:#2979FF;">${formatCurrency(pending)}</td>
                <td style="text-align:center;">${percent}%</td>
                <td style="text-align:center;">${pending<=0 ? "‚úîÔ∏è" : "‚ùå"}</td>
            </tr>`;
        });
}

/* =====================================================
üîç FILTRO EN INFORME TOTAL DE ALUMNOS
===================================================== */
function filterStudentsReport(){
    const search = (document.getElementById("searchStudentReport")?.value || "").toLowerCase();
    const rows = document.querySelectorAll("#studentsTotalTableBody tr");
    rows.forEach(row => {
        const name = (row.cells?.[0]?.innerText || "").toLowerCase();
        row.style.display = name.includes(search) ? "" : "none";
    });
}

/* =====================================================
üìå MOSTRAR DETALLES DEL ALUMNO
===================================================== */
function showStudentReportDetails(){
    const id = document.getElementById("selectStudentReport")?.value || "";
    const cont = document.getElementById("studentDetailsContainer");
    if(!cont) return;

    if(!id){
        cont.innerHTML = `<p><i>Seleccione un alumno...</i></p>`;
        return;
    }

    const s = students.find(x => x.id === id);
    if(!s) return;

    const tripCost = baseTripCost + extraTripCost;
    const benefit  = (s.sales || []).reduce((a,b)=>a+(Number(b.benefit)||0),0);
    const payments = (s.payments || []).reduce((a,b)=>a+(Number(b.amount)||0),0);
    const total = benefit + payments;
    const pending = Math.max(0, tripCost - total);
    const percent = tripCost>0 ? Math.round((total / tripCost)*100) : 0;

    cont.innerHTML = "";

    if(document.getElementById("chkGeneral")?.checked){
        cont.innerHTML += `
        <h3>${s.name||""}</h3>
        <table class="report-table">
            <tbody>
                <tr><td><strong>Clase:</strong></td><td>${s.class || "-"}</td></tr>
                <tr><td><strong>Tutor/es:</strong></td><td>${s.tutor || "-"}</td></tr>
                <tr><td><strong>Tel√©fono:</strong></td><td>${s.phone || "-"}</td></tr>
            </tbody>
        </table>
        <br>
        <table class="report-table">
            <thead>
                <tr>
                    <th>Aportado</th>
                    <th>Pendiente</th>
                    <th>% Viaje</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="text-align:right;">${formatCurrency(total)}</td>
                    <td style="text-align:right;">${formatCurrency(pending)}</td>
                    <td style="text-align:center;">${percent}%</td>
                </tr>
            </tbody>
        </table>
        <br>`;
    }

    if(document.getElementById("chkHealth")?.checked){
        cont.innerHTML += `
        <h4>üìå Informaci√≥n M√©dica</h4>
        <table class="report-table">
            <tbody>
                <tr><td><strong>Alergias:</strong></td><td>${s.alergias || "Sin datos"}</td></tr>
                <tr><td><strong>Medicamentos:</strong></td><td>${s.medicamentos || "Sin datos"}</td></tr>
                <tr><td><strong>Observaciones:</strong></td><td>${s.observaciones || "Sin datos"}</td></tr>
            </tbody>
        </table>
        <br>`;
    }

    if(document.getElementById("chkPayments")?.checked){
        cont.innerHTML += `
        <h4>üí∂ Pagos Realizados</h4>
        <table class="report-table">
            <thead><tr><th>Fecha</th><th>Importe</th><th>M√©todo</th></tr></thead>
            <tbody>
                ${
                    (!s.payments || !s.payments.length)
                    ? `<tr><td colspan="3" style="text-align:center;color:#888;">Sin pagos registrados</td></tr>`
                    : s.payments.map(p => `
                        <tr>
                            <td>${p.date || "-"}</td>
                            <td style="text-align:right;">${formatCurrency(p.amount || 0)}</td>
                            <td>${p.method || "-"}</td>
                        </tr>
                    `).join("")
                }
            </tbody>
        </table>
        <br>`;
    }

    if(document.getElementById("chkActivities")?.checked){
        cont.innerHTML += `
        <h4>üìà Actividades / Beneficios</h4>
        <table class="report-table">
            <thead><tr><th>Actividad</th><th>Beneficio</th></tr></thead>
            <tbody>
                ${
                    (!s.sales || !s.sales.length)
                    ? `<tr><td colspan="2" style="text-align:center;color:#888;">Sin actividades asignadas</td></tr>`
                    : s.sales.map(sale=>{
                        const act = activities.find(a => a.id === sale.activityId);
                        return `
                            <tr>
                                <td>${act ? act.name : "-"}</td>
                                <td style="text-align:right;">${formatCurrency(sale.benefit || 0)}</td>
                            </tr>`;
                    }).join("")
                }
            </tbody>
        </table>
        <br>`;
    }
}
/* =====================================================
üìä INFORME ACTIVIDAD POR ALUMNO (HTML)
===================================================== */
function updateStudentActivityReport(){
    const container = document.getElementById("studentActivityReportContainer");
    if(!container) return;

    const studentId  = document.getElementById("selectStudentActivityStudent")?.value || "all";
    const activityId = document.getElementById("selectStudentActivityActivity")?.value || "all";

    const rows = [];

    students.forEach((st) => {
        if (studentId !== "all" && st.id !== studentId) return;

        const sales = Array.isArray(st.sales) ? st.sales : [];
        const filteredSales = sales.filter(sa => (activityId === "all" || sa.activityId === activityId));
        if(!filteredSales.length) return;

        const details = filteredSales.map(sa => {
            const act = activities.find(a => a.id === sa.activityId);
            const name = act ? act.name : "Actividad sin nombre";
            const amount = formatCurrency(sa.benefit || 0);
            return `<li>${name} ‚Äî <strong>${amount}</strong></li>`;
        }).join("");

        const totalBenefit = filteredSales.reduce((acc,sa)=>acc+Number(sa.benefit||0),0);

        rows.push(`
            <tr style="background:${rows.length%2===0 ? '#ffffff' : '#f7f7f7'};">
                <td><strong>${st.name}</strong><br><span style="font-size:0.85rem;color:#555;">${st.class || "-"}</span></td>
                <td>
                    <ul style="margin:0;padding-left:18px;">${details}</ul>
                </td>
                <td style="text-align:right;font-weight:bold;color:#2e7d32;">
                    ${formatCurrency(totalBenefit)}
                </td>
            </tr>`);
    });

    if(!rows.length){
        container.innerHTML = `<p style="text-align:center;color:#888;">No hay datos para los filtros seleccionados.</p>`;
        return;
    }

    container.innerHTML = `
        <table class="report-table" style="width:100%; font-size:0.9rem;">
            <thead>
                <tr style="background:#e3f2fd;">
                    <th>Alumno / Curso</th>
                    <th>Detalle de actividades</th>
                    <th>Total beneficio</th>
                </tr>
            </thead>
            <tbody>${rows.join("")}</tbody>
        </table>`;
}

/* =====================================================
üìä INFORME DE ACTIVIDADES (SOLO TOTALES POR ACTIVIDAD)
===================================================== */
function updateActivitiesReport() {
    const container = document.getElementById("activitiesReportContainer");
    if (!container) return;

    const selected = document.getElementById("selectActivityReport")?.value || "all";
    const tripCost = baseTripCost + extraTripCost;
    const numStudents = students.length || 1;

    const rows = [];

    activities.forEach(act => {
        if (selected !== "all" && selected !== act.id) return;

        let benefitTotal = 0;
        let providerTotal = 0;

        students.forEach(st => {
            const sales = Array.isArray(st.sales) ? st.sales : [];
            sales.forEach(sa => {
                if (sa.activityId === act.id) {
                    benefitTotal += Number(sa.benefit || 0);
                    providerTotal += Number(sa.providerCost || 0);
                }
            });
        });

        const net = benefitTotal; // (tu correcci√≥n: NO restar proveedor)
        const percent = (tripCost > 0 && numStudents > 0)
            ? Math.round((benefitTotal / (tripCost * numStudents)) * 100)
            : 0;

        rows.push(`
            <tr>
                <td>${act.name}</td>
                <td>${formatCurrency(benefitTotal)}</td>
                <td>${formatCurrency(providerTotal)}</td>
                <td style="font-weight:bold;color:${net >= 0 ? "green" : "red"};">
                    ${formatCurrency(net)}
                </td>
                <td>${percent}%</td>
            </tr>`);
    });

    container.innerHTML = `
        <table class="report-table">
            <thead>
                <tr>
                    <th>Actividad</th>
                    <th>Beneficio</th>
                    <th>Proveedor</th>
                    <th>Neto</th>
                    <th>% viaje</th>
                </tr>
            </thead>
            <tbody>${rows.join("")}</tbody>
        </table>`;
}

/* =====================================================
üìä INFORME PROVEEDORES ‚Äî CON DESGLOSE DE PAGOS
===================================================== */
function updateProvidersReport() {
    const container = document.getElementById("providersReportContainer");
    if (!container) return;

    const providerIdFilter = document.getElementById("selectProvidersReport")?.value || "all";

    const allPayments = Array.isArray(window.providerPayments) ? window.providerPayments : [];

    if (!providers.length) {
        container.innerHTML = `<p>No hay proveedores registrados.</p>`;
        return;
    }

    let dataGrouped = providers.map(p => {
        const acts = activities.filter(a => a.providerId === p.id);

        let totalCost = 0;
        acts.forEach(act => {
            students.forEach(st => {
                (st.sales || []).forEach(sa => {
                    if (sa.activityId === act.id) totalCost += Number(sa.providerCost || 0);
                });
            });
        });

        const payments = allPayments.filter(pay => pay.providerId === p.id);
        const paid = payments.reduce((s, pay) => s + Number(pay.amount || pay.cantidad || 0), 0);
        const remaining = totalCost - paid;

        return { id:p.id, name:p.name, totalCost, paid, remaining, payments };
    });

    if (providerIdFilter !== "all") dataGrouped = dataGrouped.filter(x => x.id === providerIdFilter);

    if (!dataGrouped.length) {
        container.innerHTML = `<p><i>No hay datos para mostrar.</i></p>`;
        return;
    }

    container.innerHTML = `
        <table class="report-table" style="width:100%; margin-bottom:20px;">
            <thead>
                <tr style="background:#fafafa;">
                    <th>Proveedor</th>
                    <th style="text-align:right;">Total (‚Ç¨)</th>
                    <th style="text-align:right;">Pagado (‚Ç¨)</th>
                    <th style="text-align:right;">Pendiente (‚Ç¨)</th>
                </tr>
            </thead>
            <tbody>
                ${dataGrouped.map(p => {
                    const remColor = p.remaining > 0 ? "#c62828" : "#2e7d32";
                    const paymentsHTML = p.payments.length
                        ? p.payments.map(pay => {
                            const d = pay.date ? new Date(pay.date).toLocaleDateString("es-ES") : "-";
                            return `<div>‚Ä¢ ${d} ‚Äî <strong>${formatCurrency(pay.amount || 0)}</strong></div>`;
                        }).join("")
                        : `<i>No hay pagos registrados</i>`;

                    return `
                        <tr>
                            <td>${p.name}</td>
                            <td style="text-align:right;">${formatCurrency(p.totalCost)}</td>
                            <td style="text-align:right;">${formatCurrency(p.paid)}</td>
                            <td style="text-align:right; font-weight:bold; color:${remColor};">
                                ${formatCurrency(p.remaining)}
                            </td>
                        </tr>
                        <tr>
                            <td colspan="4" style="padding:10px 20px; background:#f9f9f9;">
                                <strong>Pagos realizados:</strong><br>
                                ${paymentsHTML}
                            </td>
                        </tr>`;
                }).join("")}
            </tbody>
        </table>`;
}

function enableOrDisableProvidersPDF(){
    const table = document.querySelector("#providersReportContainer table");
    const btn = document.getElementById("btnExportProvidersPDF");
    if (!btn) return;

    if (!table) {
        btn.disabled = true;
        btn.style.opacity = "0.4";
        btn.style.cursor = "not-allowed";
    } else {
        btn.disabled = false;
        btn.style.opacity = "1";
        btn.style.cursor = "pointer";
    }
}

/* =====================================================
üìä INFORME PAGOS GLOBAL ‚Äî DATOS
===================================================== */
function getPaymentsGlobalData() {
    const payList = Array.isArray(window.providerPayments) ? window.providerPayments : [];

    return providers.map(provider => {
        let totalCost = 0;

        const provActs = activities.filter(a => a.providerId === provider.id);
        provActs.forEach(act => {
            students.forEach(st => {
                (st.sales || []).forEach(sa => {
                    if (sa.activityId === act.id) totalCost += Number(sa.providerCost || 0);
                });
            });
        });

        const paid = payList
            .filter(p => p.providerId === provider.id)
            .reduce((s, p) => s + Number(p.amount || 0), 0);

        return { name: provider.name, total: totalCost, paid, remaining: totalCost - paid };
    });
}

function updatePaymentsGlobalReport() {
    const div = document.getElementById("paymentsGlobalContainer");
    if (!div) return;

    const rows = getPaymentsGlobalData();
    if (!rows.length) {
        div.innerHTML = "<p>No hay datos de proveedores o pagos.</p>";
        return;
    }

    div.innerHTML = `
        <table class="report-table" style="width:100%;">
            <thead>
                <tr style="background:#0d3c61; color:white;">
                    <th>Proveedor</th>
                    <th style="text-align:right;">Coste Total</th>
                    <th style="text-align:right;">Pagado</th>
                    <th style="text-align:right;">Pendiente</th>
                </tr>
            </thead>
            <tbody>
                ${rows.map(r => `
                    <tr>
                        <td>${r.name}</td>
                        <td style="text-align:right;">${formatCurrency(r.total)}</td>
                        <td style="text-align:right; color:#2e7d32;">${formatCurrency(r.paid)}</td>
                        <td style="text-align:right; font-weight:bold; color:${r.remaining > 0 ? '#c62828' : '#2e7d32'};">
                            ${formatCurrency(r.remaining)}
                        </td>
                    </tr>
                `).join("")}
            </tbody>
        </table>`;
}

/* =====================================================
üìÑ PDFs ‚Äî (los tuyos, corregidos donde hab√≠a variables mal)
===================================================== */
function exportStudentsTotalPDF() {
    if (!students.length) return alert("No hay alumnos registrados");

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p","mm","a4");

    const tripCost = baseTripCost + extraTripCost;
    const date = new Date().toLocaleDateString("es-ES");

    const margin = 12;
    let y = 22;

    doc.setFillColor(24,71,120);
    doc.rect(0,0,210,25,"F");

    doc.setFont("Helvetica","bold");
    doc.setFontSize(16);
    doc.setTextColor(255,255,255);
    doc.text("INFORME TOTAL DE ALUMNOS", 105, 9, {align:"center"});

    doc.setFontSize(10);
    doc.text("Generado: " + date, 105, 18,{align:"center"});

    y = 36;
    doc.setFont("Helvetica","normal");
    doc.setFontSize(11);
    doc.setTextColor(0,0,0);

    doc.text(`N√∫mero alumnos: ${students.length}`, margin, y); y+=6;
    doc.text(`Coste viaje por alumno: ${formatCurrency(tripCost)}`, margin, y);
    y+=10;

    const headerColor = [227,242,253];
    const col = { name: margin, class: margin+78, aport: margin+118, pend : margin+155, perc : margin+188 };

    function drawTableHeader(){
        doc.setFillColor(...headerColor);
        doc.rect(margin-2, y-4, 190-margin, 7,"F");
        doc.setFont("Helvetica","bold");
        doc.setFontSize(10);
        doc.setTextColor(24,71,120);
        doc.text("Alumno", col.name, y);
        doc.text("Clase", col.class, y);
        doc.text("Aportado", col.aport, y,{align:"right"});
        doc.text("Pend.", col.pend, y,{align:"right"});
        doc.text("%", col.perc, y,{align:"right"});
        y+=7;
    }

    drawTableHeader();

    doc.setFont("Helvetica","normal");
    doc.setFontSize(9);
    doc.setTextColor(0);

    students.slice().sort((a,b)=>String(a.name||"").localeCompare(String(b.name||""))).forEach((st,i)=>{
        const b=(st.sales||[]).reduce((x,y)=>x+(Number(y.benefit)||0),0);
        const p=(st.payments||[]).reduce((x,y)=>x+(Number(y.amount)||0),0);
        const total=b+p;
        const pend = Math.max(tripCost-total,0);
        const perc = tripCost? Math.round((total/tripCost)*100):0;

        if(y>275){ doc.addPage(); y=20; drawTableHeader(); }

        doc.setFillColor(i%2?255:245, i%2?255:245, i%2?255:245);
        doc.rect(margin-2, y-4, 190-margin, 7,"F");

        doc.text(String(st.name||""), col.name, y);
        doc.text(String(st.class||"-"), col.class, y);
        doc.text(formatCurrency(total), col.aport, y,{align:"right"});
        doc.text(formatCurrency(pend), col.pend, y,{align:"right"});
        doc.text(perc+"%", col.perc, y,{align:"right"});
        y+=7;
    });

    doc.setFontSize(8);
    doc.setTextColor(100);
    doc.text("Generado autom√°ticamente por Gesti√≥n Viaje Estudios", 105,293,{align:"center"});

    doc.save("Informe_Alumnos.pdf");
}

function exportStudentPDF() {
    const id = document.getElementById("selectStudentReport")?.value || "";
    if (!id) return alert("Seleccione un alumno primero");

    const s = students.find(x => x.id === id);
    if (!s) return alert("Alumno no encontrado");

    const includeGeneral    = document.getElementById("chkGeneral")?.checked;
    const includeHealth     = document.getElementById("chkHealth")?.checked;
    const includePayments   = document.getElementById("chkPayments")?.checked;
    const includeActivities = document.getElementById("chkActivities")?.checked;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4");

    const pageHeight = doc.internal.pageSize.height;
    const marginX = 15;
    let y = 25;

    function ensureSpace(extra=12){
        if(y + extra > pageHeight - 15){
            doc.addPage();
            y = 25;
        }
    }

    doc.setFillColor(35,76,130);
    doc.rect(0, 0, 210, 20, "F");

    doc.setFont("Helvetica","bold");
    doc.setFontSize(14);
    doc.setTextColor(255,255,255);
    doc.text("INFORME INDIVIDUAL DEL ALUMNO", 105, 8, {align:"center"});
    doc.text((s.name||"").toUpperCase(), 105, 17, {align:"center"});

    y = 35;
    doc.setFontSize(11);
    doc.setTextColor(0,0,0);
    doc.text(`Generado: ${new Date().toLocaleDateString("es-ES")}`, marginX, y);
    y += 10;

    const tripCost = baseTripCost + extraTripCost;
    const benefit  = (s.sales||[]).reduce((a,b)=>a+(Number(b.benefit)||0),0);
    const payments = (s.payments||[]).reduce((a,b)=>a+(Number(b.amount)||0),0);
    const total = benefit + payments;
    const pending = Math.max(0,tripCost-total);
    const percent = tripCost>0 ? Math.round((total/tripCost)*100) : 0;

    if(includeGeneral){
        ensureSpace(40);
        doc.setDrawColor(35,76,130);
        doc.setFillColor(235,242,252);
        doc.roundedRect(marginX - 3, y - 3, 180, 30, 3, 3, "FD");

        doc.setFont("Helvetica","bold");
        doc.setTextColor(35,76,130);
        doc.text("Datos generales", marginX, y+2);

        doc.setFont("Helvetica","normal");
        doc.setTextColor(0,0,0);
        y += 10;
        doc.text(`Clase: ${s.class || "-"}`, marginX, y); y+=5;
        doc.text(`Tutor: ${s.tutor || "-"}`, marginX, y); y+=5;
        doc.text(`Tel√©fono: ${s.phone || "-"}`, marginX, y); y+=8;

        doc.setDrawColor(46,125,50);
        doc.setFillColor(237,248,237);
        doc.roundedRect(marginX - 3, y - 3, 180, 28, 3, 3, "FD");

        doc.setFont("Helvetica","bold");
        doc.setTextColor(46,125,50);
        doc.text("Estado econ√≥mico", marginX, y+2);

        y+=10;
        doc.setFont("Helvetica","normal");
        doc.setTextColor(0,120,0);
        doc.text(`Aportado: ${formatCurrency(total)}`, marginX, y);    y+=5;
        doc.text(`Pendiente: ${formatCurrency(pending)}`, marginX, y); y+=5;
        doc.setTextColor(35,76,130);
        doc.text(`Progreso: ${percent}%`, marginX, y); y+=10;

        doc.setTextColor(0,0,0);
    }

    if(includeHealth){
        ensureSpace(25);
        doc.setDrawColor(200,200,200);
        doc.line(marginX - 5, y, 200, y); y+=6;

        doc.setFont("Helvetica","bold");
        doc.setTextColor(35,76,130);
        doc.text("Informaci√≥n m√©dica", marginX, y);
        y+=8;

        doc.setFont("Helvetica","normal");
        doc.setTextColor(0,0,0);

        doc.text(`Alergias: ${s.alergias||"Sin datos"}`, marginX, y); y+=5;
        doc.text(`Medicamentos: ${s.medicamentos||"Sin datos"}`, marginX, y); y+=5;

        const obsLines = doc.splitTextToSize(`Observaciones: ${s.observaciones||"Sin datos"}`,180);
        obsLines.forEach(line=>{
            ensureSpace(6);
            doc.text(line, marginX, y);
            y+=5;
        });

        y+=10;
    }

    if(includePayments){
        ensureSpace(25);
        doc.setDrawColor(200,200,200);
        doc.line(marginX - 5, y, 200, y); y+=6;

        doc.setFont("Helvetica","bold");
        doc.setTextColor(35,76,130);
        doc.text("Pagos realizados", marginX, y);
        y+=8;

        const pagos = s.payments||[];

        if(!pagos.length){
            doc.setFont("Helvetica","italic");
            doc.text("Sin pagos registrados", marginX, y); y+=8;
        } else {
            const col = { f: marginX, i: marginX+70 };

            doc.setFont("Helvetica","bold");
            doc.setFillColor(235,242,252);
            doc.rect(marginX - 2, y - 4, 180, 7, "F");
            doc.text("Fecha", col.f, y);
            doc.text("Importe", col.i, y,{align:"right"});
            y+=6;

            doc.setFont("Helvetica","normal");

            pagos.forEach((p,idx)=>{
                ensureSpace(9);
                doc.setFillColor(idx%2?247:255,247,247);
                doc.rect(marginX - 2, y - 4, 180, 7, "F");

                doc.setTextColor(0,0,0);
                doc.text(p.date||"", col.f, y);
                doc.setTextColor(0,120,0);
                doc.text(formatCurrency(p.amount||0), col.i, y,{align:"right"});
                doc.setTextColor(0,0,0);

                y+=8;
            });

            y+=6;
        }
    }

    if(includeActivities){
        ensureSpace(25);
        doc.setDrawColor(200,200,200);
        doc.line(marginX - 5, y, 200, y); y+=6;

        doc.setFont("Helvetica","bold");
        doc.setTextColor(35,76,130);
        doc.text("Actividades y beneficios", marginX, y);
        y+=8;

        const ventas = s.sales||[];
        const col = { a: marginX, b: marginX+130 };

        if(!ventas.length){
            doc.setFont("Helvetica","italic");
            doc.text("Sin actividades asignadas", marginX, y); y+=6;
        } else {
            doc.setFont("Helvetica","bold");
            doc.setFillColor(235,242,252);
            doc.rect(marginX - 2, y - 4, 180, 7, "F");
            doc.text("Actividad", col.a, y);
            doc.text("Beneficio", col.b, y,{align:"right"});
            y+=6;

            doc.setFont("Helvetica","normal");

            ventas.forEach((sa,idx)=>{
                ensureSpace(9);
                doc.setFillColor(idx%2?247:255,247,247);
                doc.rect(marginX - 2, y - 4, 180, 7, "F");

                const act = activities.find(a => a.id === sa.activityId);

                doc.setTextColor(0,0,0);
                doc.text(act?act.name:"-", col.a, y);
                doc.setTextColor(0,120,0);
                doc.text(formatCurrency(sa.benefit||0), col.b, y,{align:"right"});

                y+=8;
            });
            y+=4;
        }
    }

    doc.setFontSize(8);
    doc.setTextColor(120);
    doc.text("Informe generado por Gesti√≥n Viaje Estudios",
        105, pageHeight - 10, {align:"center"});

    const safeName = (s.name||"Alumno")
        .replace(/[^\w√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√± ]+/g, "")
        .replace(/\s+/g,"_");

    doc.save(`Alumno_${safeName}.pdf`);
}

/* =====================================================
üóÇÔ∏è ZIP ‚Äî Exportar PDFs individuales de TODOS los alumnos
   - Usa los mismos checks del informe por alumno:
     chkGeneral, chkHealth, chkPayments, chkActivities
   - Genera 1 PDF por alumno y los mete en un ZIP
===================================================== */

// Crea un PDF de un alumno y devuelve Blob (NO guarda)
function buildStudentPDFBlob(studentId, opts){
    const s = students.find(x => x.id === studentId);
    if (!s) return null;

    const includeGeneral    = !!opts.includeGeneral;
    const includeHealth     = !!opts.includeHealth;
    const includePayments   = !!opts.includePayments;
    const includeActivities = !!opts.includeActivities;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4");

    const pageHeight = doc.internal.pageSize.height;
    const marginX = 15;
    let y = 25;

    function ensureSpace(extra=12){
        if (y + extra > pageHeight - 15){
            doc.addPage();
            y = 25;
        }
    }

    // CABECERA
    doc.setFillColor(35,76,130);
    doc.rect(0, 0, 210, 20, "F");

    doc.setFont("Helvetica","bold");
    doc.setFontSize(14);
    doc.setTextColor(255,255,255);
    doc.text("INFORME INDIVIDUAL DEL ALUMNO", 105, 8, {align:"center"});
    doc.text((s.name||"").toUpperCase(), 105, 17, {align:"center"});

    y = 35;
    doc.setFontSize(11);
    doc.setTextColor(0,0,0);
    doc.text(`Generado: ${new Date().toLocaleDateString("es-ES")}`, marginX, y);
    y += 10;

    const tripCost = baseTripCost + extraTripCost;
    const benefit  = (s.sales||[]).reduce((a,b)=>a+(b.benefit||0),0);
    const payments = (s.payments||[]).reduce((a,b)=>a+(b.amount||0),0);
    const total = benefit + payments;
    const pending = Math.max(0,tripCost-total);
    const percent = tripCost>0 ? Math.round((total/tripCost)*100) : 0;

    // GENERAL
    if(includeGeneral){
        ensureSpace(40);
        doc.setDrawColor(35,76,130);
        doc.setFillColor(235,242,252);
        doc.roundedRect(marginX - 3, y - 3, 180, 30, 3, 3, "FD");

        doc.setFont("Helvetica","bold");
        doc.setTextColor(35,76,130);
        doc.text("Datos generales", marginX, y+2);

        doc.setFont("Helvetica","normal");
        doc.setTextColor(0,0,0);
        y += 10;
        doc.text(`Clase: ${s.class || "-"}`, marginX, y); y+=5;
        doc.text(`Tutor: ${s.tutor || "-"}`, marginX, y); y+=5;
        doc.text(`Tel√©fono: ${s.phone || "-"}`, marginX, y); y+=8;

        doc.setDrawColor(46,125,50);
        doc.setFillColor(237,248,237);
        doc.roundedRect(marginX - 3, y - 3, 180, 28, 3, 3, "FD");

        doc.setFont("Helvetica","bold");
        doc.setTextColor(46,125,50);
        doc.text("Estado econ√≥mico", marginX, y+2);

        y+=10;
        doc.setFont("Helvetica","normal");
        doc.setTextColor(0,120,0);
        doc.text(`Aportado: ${formatCurrency(total)}`, marginX, y);    y+=5;
        doc.text(`Pendiente: ${formatCurrency(pending)}`, marginX, y); y+=5;
        doc.setTextColor(35,76,130);
        doc.text(`Progreso: ${percent}%`, marginX, y); y+=10;

        doc.setTextColor(0,0,0);
    }

    // SALUD
    if(includeHealth){
        ensureSpace(25);
        doc.setDrawColor(200,200,200);
        doc.line(marginX - 5, y, 200, y); y+=6;

        doc.setFont("Helvetica","bold");
        doc.setTextColor(35,76,130);
        doc.text("Informaci√≥n m√©dica", marginX, y);
        y+=8;

        doc.setFont("Helvetica","normal");
        doc.setTextColor(0,0,0);

        doc.text(`Alergias: ${s.alergias||"Sin datos"}`, marginX, y); y+=5;
        doc.text(`Medicamentos: ${s.medicamentos||"Sin datos"}`, marginX, y); y+=5;

        const obsLines = doc.splitTextToSize(`Observaciones: ${s.observaciones||"Sin datos"}`,180);
        obsLines.forEach(line=>{
            ensureSpace(6);
            doc.text(line, marginX, y);
            y+=5;
        });

        y+=10;
    }

    // PAGOS
    if(includePayments){
        ensureSpace(25);
        doc.setDrawColor(200,200,200);
        doc.line(marginX - 5, y, 200, y); y+=6;

        doc.setFont("Helvetica","bold");
        doc.setTextColor(35,76,130);
        doc.text("Pagos realizados", marginX, y);
        y+=8;

        const pagos = s.payments||[];

        if(!pagos.length){
            doc.setFont("Helvetica","italic");
            doc.setTextColor(0,0,0);
            doc.text("Sin pagos registrados", marginX, y); y+=8;
        } else {
            const col = { f: marginX, i: marginX+70 };

            doc.setFont("Helvetica","bold");
            doc.setFillColor(235,242,252);
            doc.rect(marginX - 2, y - 4, 180, 7, "F");
            doc.setTextColor(35,76,130);
            doc.text("Fecha", col.f, y);
            doc.text("Importe", col.i, y,{align:"right"});
            y+=6;

            doc.setFont("Helvetica","normal");
            doc.setTextColor(0,0,0);

            pagos.forEach((p,idx)=>{
                ensureSpace(9);
                doc.setFillColor(idx%2?247:255,247,247);
                doc.rect(marginX - 2, y - 4, 180, 7, "F");

                doc.setTextColor(0,0,0);
                doc.text(p.date||"", col.f, y);

                doc.setTextColor(0,120,0);
                doc.text(formatCurrency(p.amount), col.i, y,{align:"right"});
                doc.setTextColor(0,0,0);

                y+=8;
            });

            y+=6;
        }
    }

    // ACTIVIDADES
    if(includeActivities){
        ensureSpace(25);
        doc.setDrawColor(200,200,200);
        doc.line(marginX - 5, y, 200, y); y+=6;

        doc.setFont("Helvetica","bold");
        doc.setTextColor(35,76,130);
        doc.text("Actividades y beneficios", marginX, y);
        y+=8;

        const ventas = s.sales||[];
        const col = { a: marginX, b: marginX+130 };

        if(!ventas.length){
            doc.setFont("Helvetica","italic");
            doc.setTextColor(0,0,0);
            doc.text("Sin actividades asignadas", marginX, y); y+=6;
        } else {
            doc.setFont("Helvetica","bold");
            doc.setFillColor(235,242,252);
            doc.rect(marginX - 2, y - 4, 180, 7, "F");
            doc.setTextColor(35,76,130);
            doc.text("Actividad", col.a, y);
            doc.text("Beneficio", col.b, y,{align:"right"});
            y+=6;

            doc.setFont("Helvetica","normal");
            doc.setTextColor(0,0,0);

            ventas.forEach((sa,idx)=>{
                ensureSpace(9);
                doc.setFillColor(idx%2?247:255,247,247);
                doc.rect(marginX - 2, y - 4, 180, 7, "F");

                const act = activities.find(a => a.id === sa.activityId);

                doc.setTextColor(0,0,0);
                doc.text(act?act.name:"-", col.a, y);

                doc.setTextColor(0,120,0);
                doc.text(formatCurrency(sa.benefit||0), col.b, y,{align:"right"});
                doc.setTextColor(0,0,0);

                y+=8;
            });
            y+=4;
        }
    }

    // PIE
    doc.setFontSize(8);
    doc.setTextColor(120);
    doc.text("Informe generado por Gesti√≥n Viaje Estudios",
        105, pageHeight - 10, {align:"center"});

    // devolver blob
    return doc.output("blob");
}

function safeFileName(name){
    return String(name || "Alumno")
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"") // sin tildes
        .replace(/[^\w\s.-]+/g,"")
        .trim()
        .replace(/\s+/g,"_");
}

async function exportAllStudentsZIP(){
    if (!window.JSZip) {
        alert("Falta JSZip. A√±ade la librer√≠a en el <head>.");
        return;
    }
    if (!students || !students.length){
        alert("No hay alumnos.");
        return;
    }

    // Leer checks actuales del informe por alumno (si est√°n)
    const opts = {
        includeGeneral:  document.getElementById("chkGeneral")?.checked ?? true,
        includeHealth:   document.getElementById("chkHealth")?.checked ?? true,
        includePayments: document.getElementById("chkPayments")?.checked ?? false,
        includeActivities: document.getElementById("chkActivities")?.checked ?? false
    };

    const zip = new JSZip();

    // Orden estable por nombre
    const list = students.slice().sort((a,b)=>(a.name||"").localeCompare(b.name||""));

    // Generar y a√±adir PDFs
    for (const st of list){
        const blob = buildStudentPDFBlob(st.id, opts);
        if (!blob) continue;
        const fname = `Alumno_${safeFileName(st.name)}.pdf`;
        zip.file(fname, blob);
    }

    // Descargar ZIP
    const zipBlob = await zip.generateAsync({ type: "blob" });
    const a = document.createElement("a");
    const url = URL.createObjectURL(zipBlob);
    a.href = url;
    a.download = `Informes_Alumnos_${new Date().toISOString().slice(0,10)}.zip`;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 500);
}

/* =====================================================
üìÑ PDF ‚Äî Actividad por Alumno (solo beneficios)
===================================================== */
async function exportStudentActivityPDF() {
    const selStudent  = document.getElementById("selectStudentActivityStudent");
    const selActivity = document.getElementById("selectStudentActivityActivity");
    if (!selStudent || !selActivity) return alert("Abra primero el informe 'Actividad por Alumno'.");

    const studentId  = selStudent.value;
    const activityId = selActivity.value;
    const date = new Date().toLocaleDateString("es-ES");

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4");

    const margin = 12;
    const pageHeight = doc.internal.pageSize.height;
    let y = 38;

    function drawHeader(title) {
        doc.setFillColor(24, 71, 120);
        doc.rect(0, 0, 210, 30, "F");

        doc.setFont("Helvetica","bold");
        doc.setFontSize(18);
        doc.setTextColor(255,255,255);
        doc.text("INFORME ACTIVIDAD POR ALUMNO", 105, 12, {align:"center"});

        doc.setFontSize(13);
        doc.text(title, 105, 24, {align:"center"});
        doc.setTextColor(0,0,0);
    }

    let title = "Todos los alumnos ¬∑ Todas las actividades";
    if (studentId !== "all") {
        const s = students.find(x => x.id === studentId);
        if (s) title = `${s.name} (${s.class || "-"})`;
    }
    if (activityId !== "all") {
        const act = activities.find(a => a.id === activityId);
        if (act) {
            title += studentId !== "all" ? " ¬∑ " : "";
            title += `Actividad: ${act.name}`;
        }
    }

    drawHeader(title);

    doc.setFont("Helvetica","normal");
    doc.setFontSize(11);
    doc.text(`Generado: ${date}`, margin, y);
    y += 10;

    function ensureSpace(extra = 20){
        if (y + extra > pageHeight - 15){
            doc.addPage();
            drawHeader(title);
            doc.setFont("Helvetica","normal");
            doc.setFontSize(11);
            doc.text(`Generado: ${date}`, margin, 38);
            y = 48;
        }
    }

    let anyRow = false;

    const studentsToPrint = students
        .filter(st => studentId === "all" || st.id === studentId)
        .slice()
        .sort((a,b)=>String(a.name||"").localeCompare(String(b.name||"")));

    studentsToPrint.forEach(st => {
        const sales = Array.isArray(st.sales) ? st.sales : [];
        const filteredSales = sales.filter(sa => (activityId === "all" || sa.activityId === activityId));
        if (!filteredSales.length) return;

        anyRow = true;
        ensureSpace(35);

        doc.setFont("Helvetica","bold");
        doc.setFontSize(13);
        doc.setTextColor(24,71,120);
        doc.text(`${st.name} ‚Äî ${st.class || "-"}`, margin, y);
        y += 6;

        doc.setDrawColor(180,180,180);
        doc.line(margin, y, 200, y);
        y += 6;

        const col = { act: margin, benef: 190 };

        doc.setFont("Helvetica","bold");
        doc.setFontSize(11);
        doc.setFillColor(227,242,253);
        doc.rect(margin - 2, y - 4, 180, 7, "F");
        doc.setTextColor(24,71,120);
        doc.text("Actividad", col.act, y);
        doc.text("Beneficio", col.benef, y, {align:"right"});
        y += 6;

        let totalBenefit = 0;
        doc.setFont("Helvetica","normal");
        doc.setTextColor(0,0,0);
        doc.setFontSize(10);

        filteredSales.forEach((sa, idx) => {
            ensureSpace(9);
            const act = activities.find(a => a.id === sa.activityId);
            const name = act ? act.name : "Actividad sin nombre";
            const amount = Number(sa.benefit || 0);
            totalBenefit += amount;

            doc.setFillColor(idx % 2 === 0 ? 250 : 235, idx % 2 === 0 ? 250 : 245, idx % 2 === 0 ? 250 : 255);
            doc.rect(margin - 2, y - 4, 180, 7, "F");

            doc.setTextColor(0,0,0);
            doc.text(name, col.act, y);
            doc.setTextColor(0,120,0);
            doc.text(formatCurrency(amount), col.benef, y, {align:"right"});
            doc.setTextColor(0,0,0);

            y += 7;
        });

        ensureSpace(10);
        doc.setFont("Helvetica","bold");
        doc.setTextColor(46,125,50);
        doc.text(`Total beneficio alumno: ${formatCurrency(totalBenefit)}`, margin, y);
        y += 10;
        doc.setTextColor(0,0,0);
    });

    if (!anyRow){
        alert("No hay datos de beneficio para los filtros seleccionados.");
        return;
    }

    doc.setFontSize(8);
    doc.setTextColor(100);
    doc.text("Informe generado autom√°ticamente por Gesti√≥n Viaje Estudios", 105, pageHeight - 6, { align:"center" });

    doc.save("Informe_Actividad_por_Alumno.pdf");
}

/* =====================================================
üìÑ PDF ‚Äî Informe por Actividad (Totales por Actividad)
===================================================== */
async function exportActivitiesPDF() {
    const selected = document.getElementById("selectActivityReport")?.value || "all";
    const date = new Date().toLocaleDateString("es-ES");

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4");

    const margin = 12;
    const pageHeight = doc.internal.pageSize.height;

    const tripCost = baseTripCost + extraTripCost;
    const numStudents = students.length || 1;

    function computeActivityTotals(act){
        let totalBenefit = 0;
        let totalProvider = 0;

        students.forEach(st => {
            const sales = Array.isArray(st.sales) ? st.sales : [];
            sales.forEach(sa => {
                if (sa.activityId === act.id) {
                    totalBenefit += Number(sa.benefit || 0);
                    totalProvider += Number(sa.providerCost || 0);
                }
            });
        });

        const netBenefit = totalBenefit; // ‚úÖ corregido (tu criterio)
        const percentTrip = (tripCost > 0 && numStudents > 0)
            ? Math.round((netBenefit / (tripCost * numStudents)) * 100)
            : 0;

        return { totalBenefit, totalProvider, netBenefit, percentTrip };
    }

    const rows = [];

    (Array.isArray(activities) ? activities : []).forEach(act => {
        if (selected !== "all" && act.id !== selected) return;
        const t = computeActivityTotals(act);
        if (t.totalBenefit === 0 && t.totalProvider === 0) return;
        rows.push({ name: act.name || "Actividad sin nombre", ...t });
    });

    if (!rows.length){
        alert("No hay datos para las actividades seleccionadas.");
        return;
    }

    function drawHeader() {
        doc.setFillColor(24, 71, 120);
        doc.rect(0, 0, 210, 30, "F");

        doc.setFont("Helvetica", "bold");
        doc.setFontSize(18);
        doc.setTextColor(255,255,255);
        doc.text("INFORME POR ACTIVIDAD", 105, 12, { align: "center" });

        doc.setFontSize(14);
        const title = (selected === "all") ? "Todas las actividades" : (rows[0]?.name || "");
        doc.text(title, 105, 24, { align: "center" });
        doc.setTextColor(0,0,0);
    }

    drawHeader();

    let y = 40;
    doc.setFont("Helvetica","normal");
    doc.setFontSize(11);
    doc.text(`Generado: ${date}`, margin, y); y += 6;
    doc.text(`Coste viaje por alumno: ${formatCurrency(tripCost)}`, margin, y); y += 6;
    doc.text(`N√∫mero de alumnos: ${numStudents}`, margin, y); y += 10;

    function ensureSpace(extra){
        if (y + extra > pageHeight - 15){
            doc.addPage();
            drawHeader();
            y = 40;
            doc.setFont("Helvetica","normal");
            doc.setFontSize(11);
            doc.text(`Generado: ${date}`, margin, y);
            y += 10;
        }
    }

    ensureSpace(15);
    doc.setFont("Helvetica","bold");
    doc.setFontSize(10);
    doc.setFillColor(227,242,253);
    doc.rect(margin - 2, y - 4, 190 - margin, 8, "F");

    const col = { name: margin, benef: margin + 80, prov: margin + 120, net: margin + 155, pct: margin + 185 };

    doc.setTextColor(24,71,120);
    doc.text("Actividad", col.name, y);
    doc.text("Beneficio", col.benef, y, {align:"right"});
    doc.text("Proveedor", col.prov,  y, {align:"right"});
    doc.text("Neto",      col.net,   y, {align:"right"});
    doc.text("% viaje",   col.pct,   y, {align:"right"});
    y += 7;

    doc.setFont("Helvetica","normal");
    doc.setFontSize(9);
    doc.setTextColor(0,0,0);

    rows.forEach((r, idx) => {
        ensureSpace(8);
        doc.setFillColor(idx % 2 === 0 ? 250 : 238, idx % 2 === 0 ? 250 : 247, idx % 2 === 0 ? 250 : 255);
        doc.rect(margin - 2, y - 4, 190 - margin, 7, "F");

        doc.text(r.name, col.name, y);
        doc.text(formatCurrency(r.totalBenefit),  col.benef, y, {align:"right"});
        doc.text(formatCurrency(r.totalProvider), col.prov,  y, {align:"right"});

        if (r.netBenefit >= 0) doc.setTextColor(0,120,0);
        else doc.setTextColor(198,40,40);

        doc.text(formatCurrency(r.netBenefit), col.net, y, {align:"right"});
        doc.setTextColor(0,0,0);
        doc.text(r.percentTrip + "%", col.pct, y, {align:"right"});
        y += 7;
    });

    doc.setFontSize(8);
    doc.setTextColor(100);
    doc.text("Informe generado autom√°ticamente por Gesti√≥n Viaje Estudios", 105, pageHeight - 6, { align:"center" });

    const baseName = (selected === "all")
        ? "Informe_Actividades_Todas"
        : `Informe_Actividad_${String(rows[0].name||"").replace(/\s+/g,"_")}`;

    doc.save(`${baseName}.pdf`);
}

/* =====================================================
üìÑ PDF ‚Äî INFORME GLOBAL DEL VIAJE
===================================================== */
function exportGlobalPDF() {
    const data = getTripData();
    if (!data.valid) return;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4");
    const pageW = doc.internal.pageSize.getWidth();

    let y = 16;

    doc.setFillColor(13, 60, 97);
    doc.rect(0, 0, pageW, 22, "F");
    doc.setTextColor(255,255,255);
    doc.setFontSize(15);
    doc.text("INFORME GLOBAL DEL VIAJE", pageW/2, 13, { align:"center" });

    doc.setFontSize(10);
    doc.setTextColor(0, 0, 0);
    doc.text("Generado: " + new Date().toLocaleDateString("es-ES"), 14, 32);
    y = 42;

    doc.setFillColor(13, 60, 97);
    doc.setTextColor(255,255,255);
    doc.rect(12, y - 6, pageW - 24, 8, "F");

    doc.text("Alumno", 14, y);
    doc.text("Coste", pageW - 90, y);
    doc.text("Cubierto", pageW - 55, y);
    doc.text("Pendiente", pageW - 20, y);
    y += 6;

    doc.setTextColor(0,0,0);

    data.studentsData.forEach((st, i) => {
        if (y > 270) { doc.addPage(); y = 20; }

        if (i % 2 === 0) {
            doc.setFillColor(245,245,245);
            doc.rect(12, y - 4, pageW - 24, 7, "F");
        }

        doc.setTextColor(0,0,0);
        doc.text(String(st.name||""), 14, y);

        doc.text(formatCurrency(st.tripCost), pageW - 90, y, { align:"right" });

        doc.setTextColor(46,125,50);
        doc.text(formatCurrency(st.totalCovered), pageW - 55, y, { align:"right" });

        if (st.pending > 0) doc.setTextColor(198,40,40);
        else doc.setTextColor(46,125,50);

        doc.text(formatCurrency(st.pending), pageW - 20, y, { align:"right" });

        y += 8;
    });

    y += 6;
    doc.setFillColor(220,230,250);
    doc.rect(12, y - 5, pageW - 24, 9, "F");

    doc.setFontSize(11);
    doc.setTextColor(0,0,120);
    doc.text("TOTALES:", 14, y + 2);

    doc.setTextColor(0,0,0);
    doc.text(formatCurrency(data.totalTripCost), pageW - 90, y + 2, { align:"right" });

    doc.setTextColor(46,125,50);
    doc.text(formatCurrency(data.totalCoveredOverall), pageW - 55, y + 2, { align:"right" });

    if (data.pendingByProviderPayments > 0) doc.setTextColor(198,40,40);
    else doc.setTextColor(46,125,50);

    doc.text(formatCurrency(data.pendingByProviderPayments), pageW - 20, y + 2, { align:"right" });

    doc.save("Informe_Global_Viaje.pdf");
}

/* =====================================================
üìÑ PDF ‚Äî INFORME GLOBAL PAGOS A PROVEEDORES
===================================================== */
function exportPaymentsGlobalPDF() {
    const rows = getPaymentsGlobalData();
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4");

    let y = 16;
    const pageW = doc.internal.pageSize.getWidth();

    doc.setFillColor(13, 60, 97);
    doc.rect(0, 0, pageW, 22, "F");
    doc.setTextColor(255,255,255);
    doc.setFontSize(15);
    doc.text("INFORME GLOBAL DE PAGOS A PROVEEDORES", pageW/2, 13, { align:"center" });

    doc.setTextColor(0,0,0);
    doc.setFontSize(10);
    doc.text("Generado: " + new Date().toLocaleDateString("es-ES"), 14, 32);

    y = 40;

    doc.setFillColor(13, 60, 97);
    doc.setTextColor(255,255,255);
    doc.rect(12, y - 6, pageW - 24, 8, "F");

    doc.text("Proveedor", 14, y);
    doc.text("Coste Total", pageW - 90, y);
    doc.text("Pagado", pageW - 55, y);
    doc.text("Pendiente", pageW - 20, y);

    y += 6;

    doc.setFontSize(10);
    doc.setTextColor(0,0,0);

    rows.forEach((r, i) => {
        if (y > 270) { doc.addPage(); y = 20; }

        if (i % 2 === 0) {
            doc.setFillColor(245,245,245);
            doc.rect(12, y - 4, pageW - 24, 7, "F");
        }

        doc.text(String(r.name||""), 14, y);
        doc.text(formatCurrency(r.total), pageW - 90, y, { align:"right" });

        doc.setTextColor(46,125,50);
        doc.text(formatCurrency(r.paid), pageW - 55, y, { align:"right" });

        if (r.remaining > 0) doc.setTextColor(198,40,40);
        else doc.setTextColor(46,125,50);

        doc.text(formatCurrency(r.remaining), pageW - 20, y, { align:"right" });

        doc.setTextColor(0,0,0);
        y += 8;
    });

    doc.setFontSize(8);
    doc.setTextColor(120);
    doc.text("Generado autom√°ticamente por Gesti√≥n Viaje Estudios", pageW/2, 290, { align:"center" });

    doc.save("Informe_Pagos_Global.pdf");
}

/* =====================================================
üìÑ PDF ‚Äî INFORME PROVEEDORES (CON DESGLOSE + FILTRO)
===================================================== */
function exportProvidersPDF() {
    const providerIdFilter = document.getElementById("selectProvidersReport")?.value || "all";

    const allPayments = Array.isArray(window.providerPayments) ? window.providerPayments : [];

    const rows = (providers || [])
        .filter(p => providerIdFilter === "all" || p.id === providerIdFilter)
        .map(p => {
            const acts = activities.filter(a => a.providerId === p.id);

            let totalCost = 0;
            students.forEach(st => {
                (st.sales || []).forEach(sa => {
                    if (acts.some(a => a.id === sa.activityId)) totalCost += Number(sa.providerCost || 0);
                });
            });

            const pays = allPayments.filter(pp => pp.providerId === p.id);
            const paid = pays.reduce((s, x) => s + Number(x.amount || 0), 0);
            const remaining = totalCost - paid;

            return { id:p.id, name:p.name, totalCost, paid, remaining, payments:pays };
        });

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4");
    const pageW = doc.internal.pageSize.getWidth();
    let y = 16;

    doc.setFillColor(13, 60, 97);
    doc.rect(0, 0, pageW, 22, "F");
    doc.setTextColor(255,255,255);
    doc.setFontSize(15);

    const title = (providerIdFilter !== "all" && rows.length === 1)
        ? `PROVEEDOR: ${rows[0].name}`
        : "INFORME DE PROVEEDORES";

    doc.text(title, pageW/2, 13, { align:"center" });

    doc.setFontSize(10);
    doc.setTextColor(0, 0, 0);
    doc.text("Generado: " + new Date().toLocaleDateString("es-ES"), 14, 32);

    y = 42;

    doc.setFillColor(13, 60, 97);
    doc.setTextColor(255,255,255);
    doc.rect(12, y - 6, pageW - 24, 8, "F");

    doc.text("Proveedor", 14, y);
    doc.text("Total (‚Ç¨)", pageW - 90, y, { align: "right" });
    doc.text("Pagado (‚Ç¨)", pageW - 55, y, { align: "right" });
    doc.text("Pendiente (‚Ç¨)", pageW - 20, y, { align: "right" });

    y += 8;
    doc.setTextColor(0,0,0);

    rows.forEach((r, i) => {
        if (y > 270) { doc.addPage(); y = 20; }

        if (i % 2 === 0) {
            doc.setFillColor(245,245,245);
            doc.rect(12, y - 4, pageW - 24, 7, "F");
        }

        doc.setTextColor(0,0,0);
        doc.text(String(r.name||""), 14, y);
        doc.text(formatCurrency(r.totalCost), pageW - 90, y, { align:"right" });
        doc.text(formatCurrency(r.paid), pageW - 55, y, { align:"right" });

        if (r.remaining > 0) doc.setTextColor(198,40,40);
        else doc.setTextColor(46,125,50);

        doc.text(formatCurrency(r.remaining), pageW - 20, y, { align:"right" });
        doc.setTextColor(0,0,0);

        y += 8;

        doc.setFontSize(9);
        if (r.payments.length) {
            doc.text("Pagos realizados:", 16, y);
            y += 4;

            r.payments.forEach(pay => {
                if (y > 270) { doc.addPage(); y = 20; }
                const d = pay.date ? new Date(pay.date).toLocaleDateString("es-ES") : "-";
                doc.text(`‚Ä¢ ${d} ‚Äî ${formatCurrency(pay.amount || 0)}`, 20, y);
                y += 5;
            });
        } else {
            doc.text("‚Ä¢ No hay pagos registrados", 20, y);
            y += 5;
        }

        doc.setFontSize(10);
        y += 4;
    });

    doc.save("Informe_Proveedores.pdf");
}

/* =====================================================
NAVEGACI√ìN SECCIONES
===================================================== */
const sectionColors = {
    dashboard: "#3498db",
    students : "#2ecc71",
    activities: "#8e44ad",
    providers: "#e67e22",
    payments : "#f1c40f",
    reports  : "#e74c3c"
};

document.querySelectorAll('.nav-link[data-section]').forEach(btn=>{
    btn.addEventListener('click',()=>{
        document.querySelectorAll('.nav-link[data-section]').forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");

        document.querySelectorAll('.content-section').forEach(sec=>sec.style.display="none");
        document.getElementById(btn.dataset.section).style.display="block";

        const nav = document.querySelector(".navbar");
        nav.style.background = sectionColors[btn.dataset.section] || "#3498db";
    });
});

/* =====================================================
MEN√ö INFORMES
===================================================== */
document.getElementById("openReportsMenu").onclick = ()=>{
    document.getElementById("reportsSidebar").classList.toggle("visible");
};

/* =====================================================
INICIO
===================================================== */
document.addEventListener("DOMContentLoaded", () => {
    updateProviderSelects();
    renderStudentsTable();
    renderActivitiesTable();
    renderProvidersTable();
    updatePaymentsView();
    updateDashboard();
});
</script>

<script>
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js")
        .then(() => console.log("Service Worker registrado"))
        .catch(err => console.error("SW error:", err));
}
</script>

</body>
</html>